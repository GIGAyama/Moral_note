<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <?!= include('css'); ?>
</head>

<body>
  <!--
    =================================================================
    1. 共通パーツ & ローディング (COMMON PARTS)
    =================================================================
  -->
  <div id="loading"
    class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex justify-content-center align-items-center"
    style="z-index: 9999;">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2 text-muted">読み込み中...</p>
    </div>
  </div>

  <nav class="navbar navbar-light bg-white shadow-sm fixed-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1 text-primary">
        <i class="bi bi-compass"></i> こころスコープ
      </span>
      <button class="btn btn-sm btn-outline-secondary" onclick="toggleTeacherMode()">
        <i class="bi bi-person-fill-gear"></i>
      </button>
    </div>
  </nav>

  <div class="container py-5 mt-4" style="max-width: 800px;">

    <!--
      =================================================================
      2. ログイン画面 (LOGIN VIEW)
      =================================================================
    -->
    <!-- View: Login (auto-login or manual select) -->
    <div id="view-login" class="d-none text-center fade-in student-view-container">
      <!-- Auto-login message (shown during auto-login) -->
      <div id="auto-login-msg" class="d-none">
        <div class="card shadow-sm mx-auto w-100" style="max-width: 600px;">
          <div class="card-body text-center p-4">
            <i class="bi bi-person-check-fill text-success" style="font-size: 4rem;"></i>
            <h3 class="card-title mt-3 mb-2 fw-bold text-primary" style="font-size: 2rem;">
              <span id="auto-login-name"></span>さん
            </h3>
            <p class="text-muted fs-4 mb-4">
              <ruby>自動<rt>じどう</rt></ruby>ログインしました
            </p>
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          </div>
        </div>
      </div>
      <!-- Manual login (fallback when auto-login is not available) -->
      <div id="manual-login-form">
        <div class="card shadow-sm mx-auto w-100" style="max-width: 600px;">
          <div class="card-body text-center p-4">
            <h3 class="card-title mb-4 fw-bold text-primary" style="font-size: 2rem;"><ruby>名前<rt>なまえ</rt></ruby>を<ruby>選
                <rt>えら</rt>
              </ruby>んでね</h3>
            <select id="student-select" class="form-select form-select-lg mb-4 py-3 fs-3" style="font-size: 1.5rem;">
              <option value="" selected disabled>ここをタップして<ruby>選<rt>えら</rt></ruby>ぶ</option>
              <!-- JSで動的生成 -->
            </select>
            <button class="btn btn-primary btn-lg w-100" onclick="login()">
              <ruby>授業<rt>じゅぎょう</rt></ruby>を<ruby>始<rt>はじ</rt></ruby>める
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 
      =================================================================
      3. 待機・入力画面 (STUDENT VIEWS)
      =================================================================
    -->
    <!-- View: Waiting -->
    <div id="view-waiting" class="d-none text-center mt-3 fade-in student-view-container">
      <div class="d-flex flex-column justify-content-center align-items-center h-100">
        <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="150" class="mb-4 opacity-50">
        <h2 class="mb-4 display-6 fw-bold"><ruby>先生<rt>せんせい</rt></ruby>の<ruby>合図<rt>あいず</rt></ruby>を<ruby>待<rt>ま</rt>
          </ruby>ってね</h2>
        <p class="text-muted fs-4"><ruby>今<rt>いま</rt></ruby>は<ruby>授業<rt>じゅぎょう</rt></ruby>が<ruby>始<rt>はじ</rt>
          </ruby>まっていません</p>
        <button class="btn btn-outline-primary btn-lg mt-4 px-5" onclick="resetApp()">
          <i class="bi bi-arrow-clockwise"></i> <ruby>更新<rt>こうしん</rt></ruby>する
        </button>
      </div>
      <div class="mt-4">
        <button class="btn btn-sm btn-info text-white" onclick="showMyLog()">
          <i class="bi bi-journal-text"></i> <ruby>自分<rt>じぶん</rt></ruby>の<ruby>記録<rt>きろく</rt></ruby>を<ruby>見<rt>み</rt>
          </ruby>る
        </button>
      </div>
    </div>

    <!-- View: Entry (Main) -->
    <div id="view-entry" class="d-none student-view-container fade-in">
      <div class="card shadow-sm mb-3 h-100">
        <div class="card-header bg-primary text-white py-3">
          <h5 class="mb-0 fs-3" id="session-title">タイトル</h5>
        </div>
        <div class="card-body d-flex flex-column justify-content-between p-4">

          <!-- Phase Label -->
          <div class="alert alert-info py-3 mb-3 text-center">
            <i class="bi bi-info-circle fs-4"></i>
            <span id="phase-label" class="fs-4 fw-bold ms-2"><ruby>今<rt>いま</rt>
              </ruby>の<ruby>考<rt>かんが</rt>
              </ruby>えを<ruby>教<rt>おし</rt></ruby>えてね</span>
          </div>

          <!-- Pattern UI Container -->
          <div id="pattern-ui-container" class="mb-4"></div>


          <!-- Reason Input -->
          <div class="mb-4">
            <label class="form-label fs-4"><ruby>理由<rt>りゆう</rt></ruby>や<ruby>考<rt>かんが</rt></ruby>え</label>
            <textarea class="form-control fs-4 p-3" id="input-text" rows="3" maxlength="500"
              placeholder="どうしてそう思ったの？" oninput="updateCharCount(this, 'char-count-entry')"></textarea>
            <div class="text-end mt-1">
              <small class="text-muted" id="char-count-entry">0 / 500</small>
            </div>
          </div>

          <!-- Submit Button -->
          <button class="btn btn-primary w-100 btn-lg shadow py-3 fs-2 fw-bold" onclick="submitOpinion()">
            <i class="bi bi-send-fill me-2"></i> <ruby>送信<rt>そうしん</rt></ruby>する
          </button>

          <!-- Opinion Share & Other Actions -->
          <div class="text-center mt-4">
            <button class="btn btn-outline-info btn-lg mb-3 w-100 py-3 d-none" id="btn-opinion-share"
              onclick="showOpinionFullscreen()">
              <i class="bi bi-people-fill me-2"></i> みんなの<ruby>考<rt>かんが</rt></ruby>えを<ruby>見<rt>み</rt></ruby>る
            </button>

            <a href="#" class="text-muted d-block mt-2" id="btn-logout-student" style="font-size: 1.1rem;"
              onclick="logoutStudent(); return false;">
              <i class="bi bi-arrow-left"></i> <ruby>名前<rt>なまえ</rt></ruby>を<ruby>変<rt>か</rt></ruby>える
            </a>
          </div>
        </div>
      </div>

      <!-- Dialogue Mode Color Beacon -->
      <div id="dialogue-mode-card" class="d-none mt-3">
        <div class="dialogue-beacon" id="dialogue-beacon" onclick="toggleDialogueFullscreen()">
          <div class="dialogue-label-area">
            <div class="dialogue-icon"><i class="bi bi-chat-heart-fill"></i></div>
            <h3><ruby>対話<rt>たいわ</rt></ruby>モード</h3>
            <p><ruby>画面<rt>がめん</rt></ruby>の<ruby>色<rt>いろ</rt></ruby>が<ruby>違<rt>ちが</rt></ruby>う<ruby>人<rt>ひと</rt></ruby>を<ruby>探<rt>さが</rt></ruby>そう！</p>
            <div id="dialogue-value-display"></div>
          </div>
          <div class="dialogue-expand-hint">
            <i class="bi bi-arrows-fullscreen"></i> タップで<ruby>大<rt>おお</rt></ruby>きくする
          </div>
        </div>
      </div>

      <div id="ai-feedback-card" class="card shadow-sm d-none mt-3 border-warning">
        <div class="card-body p-4">
          <h6 class="text-warning mb-2 fw-bold fs-5"><i class="bi bi-robot"></i> AI<ruby>先生<rt>せんせい</rt>
            </ruby>からの<ruby>問<rt>と</rt></ruby>いかけ</h6>
          <p id="ai-feedback-text" class="fw-bold mb-0 fs-4"></p>
        </div>
      </div>
    </div>

    <!-- View: Reflection (After) -->
    <div id="view-reflection" class="d-none student-view-container fade-in">
      <div class="card shadow-sm mb-3 h-100">
        <div class="card-header bg-success text-white py-3">
          <h5 class="mb-0 fs-3"><i class="bi bi-arrow-repeat"></i> <ruby>振<rt>ふ</rt></ruby>り<ruby>返<rt>かえ</rt></ruby>り
          </h5>
        </div>
        <div class="card-body p-4 d-flex flex-column">
          <!-- BEFORE Log -->
          <div class="alert alert-light border mb-4">
            <h6 class="text-muted mb-2 fw-bold"><i class="bi bi-clock-history"></i> <ruby>授業<rt>じゅぎょう</rt>
              </ruby>の<ruby>前<rt>まえ</rt></ruby>の<ruby>自分<rt>じぶん</rt></ruby></h6>
            <div id="reflection-before" class="fw-bold fs-4">
              <span class="text-muted">まだ記録がありません</span>
            </div>
          </div>
          <!-- Current Input Header -->
          <div class="alert alert-info border mb-3 py-2">
            <h6 class="mb-0 fs-5"><i class="bi bi-pencil-square"></i> <ruby>今<rt>いま</rt></ruby>の<ruby>考<rt>かんが</rt>
              </ruby>え</h6>
          </div>

          <!-- PatternRenderer用コンテナ（全パターン対応） -->
          <div id="reflection-pattern-renderer-host" class="mb-4"></div>

          <!-- Reason (Reflection) -->
          <div class="mb-4">
            <label class="form-label fs-4"><ruby>変<rt>か</rt></ruby>わった<ruby>理由<rt>りゆう</rt></ruby>は？</label>
            <textarea class="form-control fs-4 p-3" id="reflection-text" rows="3" maxlength="500"
              placeholder="友達の話を聞いて、どう思った？" oninput="updateCharCount(this, 'char-count-reflect')"></textarea>
            <div class="text-end mt-1">
              <small class="text-muted" id="char-count-reflect">0 / 500</small>
            </div>
          </div>

          <button class="btn btn-success w-100 btn-lg shadow py-3 fs-2 fw-bold" onclick="submitReflection()">
            <i class="bi bi-send-fill me-2"></i> <ruby>送信<rt>そうしん</rt></ruby>する
          </button>
        </div>
      </div>
    </div>

    <!-- View: Done -->
    <div id="view-done" class="d-none text-center mt-3 student-view-container fade-in">
      <div class="card shadow-sm mx-auto w-100" style="max-width: 600px;">
        <div class="card-body py-5 d-flex flex-column justify-content-center align-items-center">
          <i class="bi bi-check-circle-fill text-success mb-4" style="font-size: 6rem;"></i>
          <h2 class="mb-3 fw-bold"><ruby>送信<rt>そうしん</rt></ruby><ruby>完了<rt>かんりょう</rt></ruby>！</h2>
          <p class="text-muted fs-4 mb-5"><ruby>先生<rt>せんせい</rt></ruby>の<ruby>指示<rt>しじ</rt></ruby>を<ruby>待<rt>ま</rt>
            </ruby>ってね</p>

          <button class="btn btn-outline-primary btn-lg px-5 py-3 fs-3" onclick="showMyLog()">
            <i class="bi bi-journal-text me-2"></i> <ruby>自分<rt>じぶん</rt></ruby>の<ruby>記録<rt>きろく</rt></ruby>
          </button>
        </div>
      </div>
    </div>

    <!-- View: My Log (個人の歩み) -->
    <div id="view-mylog" class="d-none">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-journal-text"></i> <ruby>自分<rt>じぶん</rt></ruby>の<ruby>記録<rt>きろく</rt></ruby>
          </h5>
        </div>
        <div class="card-body">
          <div id="mylog-list">
            <div class="text-center text-muted">
              <div class="spinner-border spinner-border-sm" role="status"></div>
              <ruby>読<rt>よ</rt></ruby>み<ruby>込<rt>こ</rt></ruby>み<ruby>中<rt>ちゅう</rt></ruby>...
            </div>
          </div>
          <!-- Chart Container -->
          <div class="mt-3 border-top pt-3">
            <h6 class="text-center text-muted small"><ruby>心<rt>こころ</rt></ruby>の<ruby>位置<rt>いち</rt></ruby>の<ruby>変化<rt>
                  へんか</rt></ruby></h6>
            <div style="height: 200px;">
              <canvas id="portfolioChart"></canvas>
            </div>
          </div>
          <div class="text-center mt-3">
            <a href="#" class="text-muted small" onclick="backFromMyLog(); return false;">
              <i class="bi bi-arrow-left"></i> <ruby>戻<rt>もど</rt></ruby>る
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- 
      =================================================================
      4. 先生用ダッシュボード (TEACHER DASHBOARD)
      =================================================================
    -->
    <div id="view-teacher" class="d-none fade-in">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-primary"><i class="bi bi-speedometer2"></i> 先生用コントロール</h4>
        <div>
          <button class="btn btn-outline-secondary btn-sm me-2" onclick="resetApp()">
            <i class="bi bi-arrow-clockwise"></i> 更新
          </button>
          <button class="btn btn-secondary btn-sm" onclick="logoutTeacher()">
            <i class="bi bi-box-arrow-right"></i> 終了
          </button>
        </div>
      </div>

      <!-- Mode Switcher -->
      <ul class="nav nav-pills nav-fill mb-4">
        <li class="nav-item">
          <button class="nav-link active" id="btn-mode-prep" onclick="switchTeacherMode('prep')">
            <i class="bi bi-tools"></i> 授業準備
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="btn-mode-class" onclick="switchTeacherMode('class')">
            <i class="bi bi-display"></i> 授業実施
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="btn-mode-history" onclick="switchTeacherMode('history')">
            <i class="bi bi-clock-history"></i> 学習履歴
          </button>
        </li>
      </ul>

      <!-- MODE: Preparation -->
      <div id="teacher-mode-prep">
        <!-- 1. Session Management Card -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-header bg-white py-3">
            <ul class="nav nav-tabs card-header-tabs" id="teacher-tab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-new-session" data-bs-toggle="tab"
                  data-bs-target="#content-new-session" type="button" role="tab">新規授業</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-units" data-bs-toggle="tab" data-bs-target="#content-units"
                  type="button" role="tab" onclick="loadUnits()">単元管理</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-roster"
                  type="button" role="tab">名簿管理</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-settings"
                  type="button" role="tab">設定</button>
              </li>
            </ul>
          </div>
          <div class="card-body p-4">
            <div class="tab-content" id="myTabContent">
              <!-- Tab: 新規作成 -->
              <div class="tab-pane fade show active" id="content-new-session" role="tabpanel">
                <div class="row g-3">
                  <div class="col-md-5">
                    <label class="form-label small text-muted">教材名・ねらい</label>
                    <input type="text" class="form-control" id="new-session-title" placeholder="（例）親切について">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label small text-muted">形式</label>
                    <select class="form-select" id="new-session-type" onchange="toggleSessionOptions()">
                      <option value="SLIDER">スライダー (葛藤場面)</option>
                      <option value="TAGS">感情タグ (心情把握)</option>
                      <option value="QUADRANT">座標軸 (価値の配置)</option>
                      <option value="RANKING">ランキング (優先順位)</option>
                      <option value="CURVE">心情曲線 (気持ちの変化)</option>
                      <option value="MANDALA">マンダラ (価値定義)</option>
                      <option value="ACTION">宣言カード (自分事)</option>
                    </select>
                  </div>
                  <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-success w-100" onclick="createNewSession()">
                      <i class="bi bi-play-circle-fill"></i> 授業を開始
                    </button>
                  </div>
                </div>

                <!-- Options -->
                <div id="session-opts-slider" class="row g-3 mt-1 session-opts">
                  <div class="col-6">
                    <input type="text" class="form-control form-control-sm" id="opt-slider-min"
                      placeholder="左端ラベル (例: 賛成)" value="賛成">
                  </div>
                  <div class="col-6">
                    <input type="text" class="form-control form-control-sm" id="opt-slider-max"
                      placeholder="右端ラベル (例: 反対)" value="反対">
                  </div>
                </div>
                <div id="session-opts-tags" class="mt-2 d-none session-opts">
                  <input type="text" class="form-control form-control-sm" id="opt-tags-list" placeholder="タグ (カンマ区切り)"
                    value="共感,疑問,納得,驚き">
                </div>

                <!-- Option: Quadrant -->
                <div id="session-opts-quadrant" class="mt-2 d-none session-opts">
                  <div class="row g-2">
                    <div class="col-6">
                      <label class="small text-muted">X軸 (左右)</label>
                      <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="opt-quad-xmin" placeholder="左" value="左">
                        <input type="text" class="form-control" id="opt-quad-xmax" placeholder="右" value="右">
                      </div>
                    </div>
                    <div class="col-6">
                      <label class="small text-muted">Y軸 (上下)</label>
                      <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="opt-quad-ymin" placeholder="下" value="下">
                        <input type="text" class="form-control" id="opt-quad-ymax" placeholder="上" value="上">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Option: Ranking -->
                <div id="session-opts-ranking" class="mt-2 d-none session-opts">
                  <label class="small text-muted">並べ替える項目（カンマ区切り）</label>
                  <input type="text" class="form-control form-control-sm" id="opt-ranking-items"
                    placeholder="（例）正直,親切,勇気,思いやり" value="項目A,項目B,項目C,項目D">
                </div>

                <!-- Option: Curve -->
                <div id="session-opts-curve" class="mt-2 d-none session-opts">
                  <label class="small text-muted">場面（カンマ区切り）</label>
                  <input type="text" class="form-control form-control-sm" id="opt-curve-scenes"
                    placeholder="（例）はじめ,展開,山場,結末" value="はじめ,展開,山場,結末">
                </div>

                <!-- Option: Mandala -->
                <div id="session-opts-mandala" class="mt-2 d-none session-opts">
                  <label class="small text-muted">中心テーマ</label>
                  <input type="text" class="form-control form-control-sm" id="opt-mandala-theme" placeholder="（例）友情、親切"
                    value="考えるテーマ">
                </div>
              </div>

              <!-- Tab: 単元管理 -->
              <div class="tab-pane fade" id="content-units" role="tabpanel">
                <div class="mb-4 p-3 bg-light rounded-3">
                  <label class="form-label fw-bold text-primary"><i class="bi bi-magic"></i> AIインポート (PDF)</label>
                  <div class="mb-3">
                    <input type="file" class="form-control" id="pdf-file-input" accept="application/pdf">
                    <button class="btn btn-primary mt-2 w-100" type="button" onclick="importUnitFromPdf()">
                      <i class="bi bi-magic"></i> PDFから読み取り
                    </button>
                  </div>
                  <div class="form-text">指導案PDFから単元情報を自動抽出します</div>
                </div>

                <div class="row">
                  <div class="col-md-5">
                    <h6 class="fw-bold text-muted mb-2">登録済み単元</h6>
                    <div id="unit-list-container" class="list-group list-group-flush border rounded mb-3"
                      style="max-height: 400px; overflow-y: auto;">
                      <div class="text-center text-muted py-4">読み込み中...</div>
                    </div>
                  </div>
                  <div class="col-md-7">
                    <div class="card border" id="unit-edit-card">
                      <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                        <small class="fw-bold" id="unit-form-header">
                          <i class="bi bi-plus-circle me-1"></i>新規作成
                        </small>
                        <button class="btn btn-sm btn-outline-secondary d-none" id="btn-cancel-edit" onclick="clearUnitForm()">
                          <i class="bi bi-x-lg me-1"></i>新規に戻る
                        </button>
                      </div>
                      <div class="card-body">
                        <input type="hidden" id="edit-unit-id">
                        <input type="text" class="form-control mb-2" id="edit-unit-title" placeholder="タイトル">
                        <div class="mb-2">
                          <select class="form-select form-select-sm mb-2" id="edit-unit-type"
                            onchange="toggleUnitEditOptions()">
                            <option value="SLIDER">スライダー</option>
                            <option value="TAGS">感情タグ</option>
                            <option value="QUADRANT">座標軸</option>
                            <option value="RANKING">ランキング</option>
                            <option value="CURVE">心情曲線</option>
                            <option value="MANDALA">マンダラ</option>
                            <option value="ACTION">宣言カード</option>
                          </select>
                          <div id="edit-unit-opts-slider" class="input-group input-group-sm">
                            <input type="text" class="form-control" id="edit-unit-min" placeholder="左ラベル">
                            <input type="text" class="form-control" id="edit-unit-max" placeholder="右ラベル">
                          </div>
                          <div id="edit-unit-opts-tags" class="d-none">
                            <input type="text" class="form-control form-control-sm" id="edit-unit-tags"
                              placeholder="タグ (カンマ区切り)">
                          </div>
                          <div id="edit-unit-opts-quadrant" class="d-none">
                            <div class="input-group input-group-sm mb-1">
                              <span class="input-group-text">X軸</span>
                              <input type="text" class="form-control" id="edit-unit-quad-xmin" placeholder="左">
                              <input type="text" class="form-control" id="edit-unit-quad-xmax" placeholder="右">
                            </div>
                            <div class="input-group input-group-sm">
                              <span class="input-group-text">Y軸</span>
                              <input type="text" class="form-control" id="edit-unit-quad-ymin" placeholder="下">
                              <input type="text" class="form-control" id="edit-unit-quad-ymax" placeholder="上">
                            </div>
                          </div>
                          <div id="edit-unit-opts-ranking" class="d-none">
                            <input type="text" class="form-control form-control-sm" id="edit-unit-ranking-items"
                              placeholder="項目 (カンマ区切り)">
                          </div>
                          <div id="edit-unit-opts-curve" class="d-none">
                            <input type="text" class="form-control form-control-sm" id="edit-unit-curve-scenes"
                              placeholder="場面 (カンマ区切り)">
                          </div>
                          <div id="edit-unit-opts-mandala" class="d-none">
                            <input type="text" class="form-control form-control-sm" id="edit-unit-mandala-theme"
                              placeholder="中心テーマ">
                          </div>
                        </div>
                        <textarea class="form-control form-control-sm mb-3" id="edit-unit-memo" rows="4"
                          placeholder="指導メモ"></textarea>
                        <div class="d-flex justify-content-end gap-2">
                          <button class="btn btn-sm btn-outline-secondary" onclick="clearUnitForm()">クリア</button>
                          <button class="btn btn-sm btn-primary" id="btn-save-unit" onclick="saveUnitForm()">
                            <i class="bi bi-save me-1"></i>保存
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div><!-- end tab-pane -->

              <!-- Tab: 名簿管理 -->
              <div class="tab-pane fade" id="content-roster" role="tabpanel">
                <div class="alert alert-info small mb-3">
                  <i class="bi bi-info-circle me-1"></i>
                  児童のGoogleアカウント（メールアドレス）を登録すると、自動ログインが有効になります。
                </div>
                <div id="roster-list" class="list-group list-group-flush border rounded mb-3"
                  style="max-height: 400px; overflow-y: auto;">
                  <!-- JS populated -->
                </div>
                <div class="bg-light rounded p-3">
                  <div class="row g-2 mb-2">
                    <div class="col-4">
                      <input type="text" class="form-control form-control-sm" id="new-student-name" placeholder="名前">
                    </div>
                    <div class="col-3">
                      <input type="text" class="form-control form-control-sm" id="new-student-ruby" placeholder="ふりがな">
                    </div>
                    <div class="col-5">
                      <input type="email" class="form-control form-control-sm" id="new-student-email" placeholder="メールアドレス（任意）">
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-success flex-grow-1" onclick="addNewStudent()">
                      <i class="bi bi-person-plus"></i> 追加
                    </button>
                    <button class="btn btn-sm btn-outline-secondary flex-grow-1" onclick="registerBulkStudents()">
                      <i class="bi bi-file-earmark-spreadsheet"></i> 一括登録
                    </button>
                  </div>
                </div>
              </div>

              <!-- Tab: 設定 -->
              <div class="tab-pane fade" id="content-settings" role="tabpanel">
                <label class="form-label small fw-bold">Gemini API Key</label>
                <div class="input-group input-group-sm mb-3">
                  <input type="password" class="form-control" id="gemini-api-key-input" placeholder="API Key">
                  <button class="btn btn-outline-secondary" onclick="saveApiKey()">保存</button>
                </div>
                <p class="text-muted status-text small mb-0" id="gemini-status">Status: Checking...</p>
                <hr class="my-3">
                <label class="form-label small fw-bold">教師パスワード</label>
                <button class="btn btn-outline-primary btn-sm w-100 mb-3" onclick="promptPasswordChange()">
                  <i class="bi bi-key me-1"></i> パスワードを変更
                </button>
                <hr class="my-3">
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-danger btn-sm"
                    onclick="if(confirm('全てのデータをリセットしますか？')) { /* TODO */ }">
                    <i class="bi bi-trash"></i> データの初期化 (未実装)
                  </button>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div><!-- End Prep Mode -->

      <!-- MODE: Classroom (Board) -->
      <div id="teacher-mode-class" class="d-none">
        <!-- Phase Control (Full Width) -->
        <div class="card shadow-sm border-0 mb-4 bg-primary bg-opacity-10 border-primary border-opacity-25">
          <div class="card-body p-4 text-center">
            <div class="d-flex justify-content-center align-items-center gap-2 mb-3">
              <span class="badge bg-primary fs-6">現在: <span id="current-phase-display-class">BEFORE</span></span>
            </div>
            <div class="btn-group btn-group-lg shadow-sm" role="group">
              <button class="btn btn-primary px-5" id="btn-phase-BEFORE-class" onclick="changePhase('BEFORE')">
                <i class="bi bi-1-circle"></i> 導入
              </button>
              <button class="btn btn-outline-primary px-5" id="btn-phase-AFTER-class" onclick="changePhase('AFTER')">
                <i class="bi bi-2-circle"></i> 振り返り
              </button>
              <button class="btn btn-outline-danger px-4" id="btn-phase-CLOSED-class" onclick="changePhase('CLOSED')">
                <i class="bi bi-stop-circle"></i> 終了
              </button>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Class Analytics -->
          <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4 h-100">
              <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-primary h6"><i class="bi bi-graph-up"></i> クラスの状態 (リアルタイム分布)</h5>
              </div>
              <div class="card-body p-4">
                <!-- 散布図（SLIDER / QUADRANT） -->
                <div id="chart-scatter-container" style="height: 400px;">
                  <canvas id="scatterChart"></canvas>
                </div>
                <!-- パターン別可視化コンテナ（TAGS/RANKING/CURVE/MANDALA/ACTION） -->
                <div id="chart-pattern-container" class="d-none" style="max-height: 400px; overflow-y: auto;"></div>
              </div>
            </div>
          </div>

          <!-- Text Mining / Summary -->
          <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-4 h-100">
              <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary h6"><i class="bi bi-chat-quote"></i> 変容サマリー</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadStudentSummaries()">
                  <i class="bi bi-arrow-repeat"></i> 更新
                </button>
              </div>
              <div class="card-body p-0">
                <div id="summary-container" class="list-group list-group-flush"
                  style="max-height: 400px; overflow-y: auto;">
                  <div class="text-center text-muted py-5">
                    <p class="small">「更新」ボタンを押すと、生徒ごとの変容が表示されます</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- End Class Mode -->

      <!-- MODE: History (学習履歴・所見) -->
      <div id="teacher-mode-history" class="d-none">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-header bg-white py-3">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#content-history-unit"
                  type="button" role="tab">単元別履歴</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-history-student"
                  type="button" role="tab">児童別履歴</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-observation"
                  type="button" role="tab">所見作成</button>
              </li>
            </ul>
          </div>
          <div class="card-body p-4">
            <div class="tab-content">

              <!-- Tab: 単元別履歴 -->
              <div class="tab-pane fade show active" id="content-history-unit" role="tabpanel">
                <div class="mb-3 d-flex gap-2 align-items-end">
                  <div class="flex-grow-1">
                    <label class="form-label small text-muted">実施済み授業を選択</label>
                    <select class="form-select" id="history-session-select"
                      onchange="loadSessionHistory(this.value)">
                      <option value="">-- 授業を選んでください --</option>
                    </select>
                  </div>
                  <button class="btn btn-outline-success btn-sm d-none" id="btn-export-csv" onclick="exportCsv()">
                    <i class="bi bi-download me-1"></i>CSV
                  </button>
                </div>
                <div id="history-session-detail">
                  <div class="text-center text-muted py-5">
                    <i class="bi bi-arrow-up-circle d-block fs-1 mb-2 opacity-50"></i>
                    <p>上のドロップダウンから授業を選ぶと、<br>全児童の学習記録が表示されます</p>
                  </div>
                </div>
              </div>

              <!-- Tab: 児童別履歴 -->
              <div class="tab-pane fade" id="content-history-student" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label small text-muted">児童を選択</label>
                  <select class="form-select" id="history-student-select"
                    onchange="loadStudentHistoryView(this.value)">
                    <option value="">-- 児童を選んでください --</option>
                  </select>
                </div>
                <div id="history-student-detail">
                  <div class="text-center text-muted py-5">
                    <i class="bi bi-arrow-up-circle d-block fs-1 mb-2 opacity-50"></i>
                    <p>上のドロップダウンから児童を選ぶと、<br>その児童の全授業記録が表示されます</p>
                  </div>
                </div>
              </div>

              <!-- Tab: 所見作成 -->
              <div class="tab-pane fade" id="content-observation" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label small text-muted">児童を選択</label>
                  <select class="form-select" id="observation-student-select"
                    onchange="previewStudentForObservation(this.value)">
                    <option value="">-- 児童を選んでください --</option>
                  </select>
                </div>
                <div id="observation-preview" class="mb-3"></div>
                <button class="btn btn-primary w-100 mb-3 d-none" id="btn-generate-observation"
                  onclick="generateObservationForStudent()">
                  <i class="bi bi-magic me-1"></i> AIで所見を作成
                </button>
                <div id="observation-result" class="d-none">
                  <label class="form-label fw-bold"><i class="bi bi-file-text me-1"></i>生成された所見</label>
                  <textarea class="form-control mb-2" id="observation-text" rows="8"
                    style="font-size: 1rem; line-height: 1.8;"></textarea>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="copyObservation()">
                      <i class="bi bi-clipboard me-1"></i>コピー
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="generateObservationForStudent()">
                      <i class="bi bi-arrow-repeat me-1"></i>再生成
                    </button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div><!-- End History Mode -->

    </div>


  </div>

  <!-- Dialogue Mode Fullscreen Overlay -->
  <div id="dialogue-fullscreen" class="d-none">
    <div class="dialogue-fs-beacon" id="dialogue-fs-beacon">
      <div class="dialogue-fs-content">
        <div class="dialogue-fs-icon"><i class="bi bi-chat-heart-fill"></i></div>
        <h1><ruby>対話<rt>たいわ</rt></ruby>モード</h1>
        <p><ruby>画面<rt>がめん</rt></ruby>の<ruby>色<rt>いろ</rt></ruby>が<ruby>違<rt>ちが</rt></ruby>う<ruby>人<rt>ひと</rt></ruby>を<ruby>探<rt>さが</rt></ruby>そう！</p>
        <div id="dialogue-fs-value" class="mt-3"></div>
      </div>
      <button class="dialogue-fs-close" onclick="closeDialogueFullscreen()">
        <i class="bi bi-x-lg me-1"></i><ruby>閉<rt>と</rt></ruby>じる
      </button>
    </div>
  </div>

  <!-- Fullscreen Opinion Overlay (outside container) -->
  <div id="fullscreen-opinions" class="d-none">
    <div class="fs-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-bold text-primary">
        <i class="bi bi-people-fill me-2"></i>みんなの<ruby>考<rt>かんが</rt></ruby>え
      </h5>
      <button class="btn btn-outline-secondary" onclick="closeOpinionFullscreen()">
        <i class="bi bi-x-lg me-1"></i><ruby>閉<rt>と</rt></ruby>じる
      </button>
    </div>
    <div id="fullscreen-opinion-content">
      <!-- Pattern-specific fullscreen content rendered by JS -->
    </div>
  </div>

  <!-- Bulk Import Preview Modal -->
  <div class="modal fade" id="bulkImportModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-list-check"></i> 一括登録プレビュー</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="alert alert-info small">
            <i class="bi bi-info-circle"></i> PDFから抽出された単元候補です。登録したいものにチェックを入れてください。
          </p>
          <div class="list-group" id="bulk-import-list">
            <!-- JS populated -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-success" onclick="saveBulkUnits()">
            <i class="bi bi-save"></i> 選択した単元を登録
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="text-center text-muted py-3 mt-4 border-top bg-white">
    <small>© 2026 こころスコープ <a href="https://note.com/cute_borage86" target="_blank"
        class="text-decoration-none text-muted">GIGA山</a></small>
  </footer>

  <!-- Bootstrap & Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <?!= include('js_patterns'); ?>
  <?!= include('js'); ?>
</body>

</html>