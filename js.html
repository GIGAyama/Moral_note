<script>
/**
 * Global State
 */
let currentUser = null;
let currentSession = null;
let currentPhase = 'BEFORE'; // BEFORE, MIDDLE, AFTER
let scatterChart = null;
let sliderColor = '#1a73e8';
let loadingTimeout = null;
let selectedTag = '';
let currentViewId = '';
let submittedPhases = new Set(); // 重複送信ガード

/**
 * Utility: HTMLエスケープ（XSS対策）
 */
function escapeHtml(str) {
  if (str == null) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

/**
 * Utility: 共通タグボタン生成
 */
function buildTagButtons(container, tags, onSelect) {
  container.innerHTML = '';
  tags.forEach(tag => {
    const btn = document.createElement('div');
    btn.className = 'emotion-tag';
    btn.innerText = tag;
    btn.onclick = () => onSelect(btn);
    container.appendChild(btn);
  });
}

/**
 * Initialization
 */
document.addEventListener('DOMContentLoaded', () => {
  // 1. セーフティネット: 15秒経っても読み込みが終わらない場合は救済ボタンを出す
  loadingTimeout = setTimeout(() => {
    const loader = document.getElementById('loading');
    if (loader && !loader.classList.contains('d-none')) {
      loader.innerHTML = `
        <div class="alert alert-warning">
          <p>読み込みに時間がかかっています。</p>
          <button class="btn btn-sm btn-outline-dark" onclick="location.reload()">再読み込み</button>
        </div>`;
    }
  }, 15000);

  // 2. 先生モード判定（最優先）
  const isTeacher = localStorage.getItem('isTeacher') === 'true';
  if (isTeacher) {
    showView('view-teacher'); // 先に画面を出しておく
  }

  // 3. データ取得開始
  runGoogleScript('getInitialData')
    .then(response => {
      // タイムアウト解除
      clearTimeout(loadingTimeout);
      document.getElementById('loading').classList.add('d-none');
      
      // レスポンス検証
      if (!response || !response.success) {
        throw new Error(response ? response.error : 'データ取得失敗');
      }

      const data = response;

      // 先生ならここで処理終了（生徒用ロジックには行かせない）
      if (isTeacher) {
        if (data.activeSession) {
          currentSession = data.activeSession;
          updatePhaseButtons(currentSession.phase || 'BEFORE');
        }
        updateActiveSessionInfo();
        renderRoster(data.users);
        initChart();       // チャート準備
        loadScatterData(); // データロード
        checkGeminiStatus(); // AI設定確認
        return;            // ★重要: ここでリターンして生徒ロジックを遮断
      }

      // --- 以下、生徒用ロジック ---

      // 名簿セット
      const select = document.getElementById('student-select');
      if (data.users && Array.isArray(data.users) && data.users.length > 0) {
        // 既存の選択肢をクリア
        select.innerHTML = '<option value="" selected disabled>ここをタップして選ぶ</option>';
        data.users.forEach(u => {
          const option = document.createElement('option');
          option.value = u.id;
          option.innerHTML = `${u.name} <small>(${u.ruby})</small>`;
          select.appendChild(option);
        });
      }

      // セッション状態による分岐
      if (data.activeSession) {
        currentSession = data.activeSession;
        currentPhase = currentSession.phase || 'BEFORE';
        setupSessionUI(currentSession);

        // ログイン画面に授業タイトルを表示
        const loginTitle = document.getElementById('login-session-title');
        if (loginTitle) loginTitle.innerText = currentSession.title;

        // フェーズラベル更新
        const phaseLabels = { BEFORE: '今の考えを教えてね', AFTER: '振り返りの時間です' };
        const phaseLabel = document.getElementById('phase-label');
        if (phaseLabel && phaseLabels[currentPhase]) {
          phaseLabel.innerHTML = phaseLabels[currentPhase];
        }

        // ログイン済みかチェック
        const storedUid = localStorage.getItem('studentId');
        if (storedUid) {
          currentUser = { id: storedUid };
          if (currentPhase === 'AFTER' && !submittedPhases.has('AFTER')) {
            showReflectionView();
          } else {
            showView('view-entry'); // 入力画面へ
          }
        } else {
          showView('view-login'); // ログイン画面へ
        }
      } else {
        // セッションがない場合
        showView('view-waiting');
      }
    })
    .catch(err => {
      clearTimeout(loadingTimeout);
      document.getElementById('loading').classList.add('d-none');
      console.error(err);
      
      // エラーが出てもホワイトアウトさせず、エラー表示をする
      Swal.fire({
        icon: 'error',
        title: '通信エラー',
        text: 'データの読み込みに失敗しました。再読み込みしますか？',
        showCancelButton: true,
        confirmButtonText: '再読み込み',
      }).then((result) => {
        if (result.isConfirmed) {
          location.reload();
        }
      });
    });
});

/**
 * UI Logic (Safe Transition)
 */
function showView(viewId) {
  // すべてのビューを隠す
  const allViews = document.querySelectorAll('[id^="view-"]');
  allViews.forEach(el => {
    el.classList.add('d-none');
    el.classList.remove('fade-in'); // 前回のアニメーションクラスを除去
  });

  // 指定されたビューを表示
  const target = document.getElementById(viewId);
  if (target) {
    target.classList.remove('d-none');
    target.classList.add('fade-in');
    currentViewId = viewId;
  } else {
    // 万が一IDが間違っていたら待機画面を出す（ホワイトアウト防止）
    console.warn(`View ID "${viewId}" not found. Fallback to waiting.`);
    const fallback = document.getElementById('view-waiting');
    if(fallback) fallback.classList.remove('d-none');
    currentViewId = 'view-waiting';
  }
}

function login() {
  const select = document.getElementById('student-select');
  const uid = select.value;
  if (!uid) {
    Swal.fire('名前を選んでね', '', 'warning');
    return;
  }
  
  localStorage.setItem('studentId', uid);
  currentUser = { id: uid };
  showView('view-entry');
}

function setupSessionUI(session) {
  const titleEl = document.getElementById('session-title');
  if(titleEl) titleEl.innerText = session.title;
  
  // UIリセット
  document.getElementById('input-mode-slider').classList.add('d-none');
  document.getElementById('input-mode-tags').classList.add('d-none');

  // 入力モード切替
  if (session.inputType === 'SLIDER') {
    document.getElementById('input-mode-slider').classList.remove('d-none');
    document.getElementById('slider-label-min').innerText = session.options.minLabel || 'A';
    document.getElementById('slider-label-max').innerText = session.options.maxLabel || 'B';
    // 初期カラー設定
    updateSliderColor(document.getElementById('input-slider').value);
  } else if (session.inputType === 'TAGS') {
    document.getElementById('input-mode-tags').classList.remove('d-none');
    const container = document.getElementById('tags-container');
    const tags = session.options.tags || ['うれしい', 'かなしい', 'くやしい', '迷う'];
    buildTagButtons(container, tags, selectTag);
  }
}

function updateSliderColor(val) {
  document.getElementById('slider-value-display').innerText = val;
  const r = Math.floor(255 * (100 - val) / 100);
  const b = Math.floor(255 * val / 100);
  sliderColor = `rgb(${r}, 50, ${b})`;
  
  const bg = document.getElementById('color-match-bg');
  if(bg) bg.style.backgroundColor = `rgba(${r}, 50, ${b}, 0.2)`;
}

function selectTag(el) {
  document.querySelectorAll('.emotion-tag').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  selectedTag = el.innerText;
}

/**
 * Action: 送信
 */
function submitOpinion() {
  if (!currentUser || !currentSession) return;

  // 重複送信ガード
  if (submittedPhases.has(currentPhase)) {
    Swal.fire('もう送ってあるよ', 'この回は送信ずみです', 'info');
    return;
  }

  const text = document.getElementById('input-text').value;
  let val = 0;

  if (currentSession.inputType === 'SLIDER') {
    val = Number(document.getElementById('input-slider').value);
  } else if (currentSession.inputType === 'TAGS') {
    if (!selectedTag) {
      Swal.fire('気持ちを選んでね', '', 'warning');
      return;
    }
    val = selectedTag;
  }

  const payload = {
    sessionId: currentSession.id,
    studentId: currentUser.id,
    phase: currentPhase,
    value: val,
    text: text
  };

  Swal.fire({ title: '送信中...', didOpen: () => Swal.showLoading() });

  runGoogleScript('submitLog', payload)
    .then(() => {
      submittedPhases.add(currentPhase);

      Swal.fire({
        icon: 'success',
        title: '送りました！',
        text: '友達の意見を聞いてみよう',
        timer: 1500,
        showConfirmButton: false
      });

      if (currentSession.inputType === 'SLIDER') {
         const card = document.getElementById('color-match-card');
         if(card) card.classList.remove('d-none');
      }

      // 送信済み表示
      const submitBtn = document.querySelector('#view-entry .btn-primary.btn-lg');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> 送信ずみ';
      }

      // フォームリセット
      document.getElementById('input-text').value = '';
      selectedTag = '';
      document.querySelectorAll('.emotion-tag').forEach(e => e.classList.remove('active'));

      // AIフィードバックを非同期で取得
      document.getElementById('ai-feedback-card').classList.add('d-none');
      if (currentSession) {
        requestAiFeedback(currentSession.title, text, currentSession.inputType, val);
      }
    })
    .catch(showError);
}

/**
 * Teacher Functions
 */
function logoutTeacher() {
  localStorage.removeItem('isTeacher');
  location.reload();
}

function logoutStudent() {
  localStorage.removeItem('studentId');
  currentUser = null;
  showView('view-login');
}

function toggleTeacherMode() {
  const isT = localStorage.getItem('isTeacher') === 'true';
  if (isT) {
    if(confirm('先生モードを終了しますか？')) {
      localStorage.removeItem('isTeacher');
      location.reload();
    }
  } else {
    const pass = prompt('先生用パスワードを入力してください');
    if (pass === 'admin') {
      localStorage.setItem('isTeacher', 'true');
      location.reload(); // リロードして確実に先生モードで起動
    }
  }
}

function toggleSessionOptions() {
  const type = document.getElementById('new-session-type').value;
  document.getElementById('session-opts-slider').classList.toggle('d-none', type !== 'SLIDER');
  document.getElementById('session-opts-tags').classList.toggle('d-none', type !== 'TAGS');
}

function createNewSession() {
  const title = document.getElementById('new-session-title').value;
  if (!title) { Swal.fire('タイトルを入れてね', '', 'warning'); return; }

  const type = document.getElementById('new-session-type').value;
  let options = {};

  if (type === 'SLIDER') {
    const minLabel = document.getElementById('opt-slider-min').value.trim() || '賛成';
    const maxLabel = document.getElementById('opt-slider-max').value.trim() || '反対';
    options = { minLabel: minLabel, maxLabel: maxLabel, tags: [] };
  } else if (type === 'TAGS') {
    const tagsStr = document.getElementById('opt-tags-list').value.trim();
    const tags = tagsStr ? tagsStr.split(/[,、，]/).map(t => t.trim()).filter(t => t) : ['共感', '疑問', '納得', '驚き'];
    options = { tags: tags };
  }

  Swal.fire({ title: '授業を作成中...', didOpen: () => Swal.showLoading() });

  runGoogleScript('createSession', title, type, JSON.stringify(options))
    .then(() => {
      Swal.fire({
        icon: 'success',
        title: '作成しました',
        text: '生徒に「再読込み」するように伝えてください',
      });
      // フォームリセット
      document.getElementById('new-session-title').value = '';
      // セッション情報をリロードして散布図を更新
      runGoogleScript('getInitialData').then(response => {
        if (response && response.success && response.activeSession) {
          currentSession = response.activeSession;
          updatePhaseButtons(currentSession.phase || 'BEFORE');
          updateActiveSessionInfo();
          loadScatterData();
        }
      });
    })
    .catch(showError);
}

/**
 * Phase Management (Teacher)
 */
function changePhase(newPhase) {
  if (!currentSession) {
    Swal.fire('授業が選択されていません', '', 'warning');
    return;
  }

  if (newPhase === 'CLOSED') {
    Swal.fire({
      title: '授業を終了しますか？',
      text: '生徒は入力できなくなります',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: '終了する',
      cancelButtonText: 'キャンセル'
    }).then(result => {
      if (result.isConfirmed) {
        runGoogleScript('closeSession', currentSession.id)
          .then(() => {
            currentSession = null;
            updatePhaseButtons('CLOSED');
            updateActiveSessionInfo();
            Swal.fire('授業を終了しました', '', 'success');
          })
          .catch(showError);
      }
    });
    return;
  }

  Swal.fire({ title: 'フェーズ変更中...', didOpen: () => Swal.showLoading() });

  runGoogleScript('updateSessionPhase', currentSession.id, newPhase)
    .then(result => {
      if (result && result.success) {
        currentSession.phase = newPhase;
        updatePhaseButtons(newPhase);
        Swal.fire({
          icon: 'success',
          title: 'フェーズ変更完了',
          text: newPhase === 'BEFORE' ? '導入フェーズです' : '振り返りフェーズです',
          timer: 1500,
          showConfirmButton: false
        });
      }
    })
    .catch(showError);
}

function updatePhaseButtons(phase) {
  const phases = ['BEFORE', 'AFTER', 'CLOSED'];
  phases.forEach(p => {
    const btn = document.getElementById('btn-phase-' + p);
    if (!btn) return;
    if (p === phase) {
      btn.classList.remove('btn-outline-secondary', 'btn-outline-danger');
      btn.classList.add(p === 'CLOSED' ? 'btn-danger' : 'btn-primary');
    } else {
      btn.classList.remove('btn-primary', 'btn-danger');
      btn.classList.add(p === 'CLOSED' ? 'btn-outline-danger' : 'btn-outline-secondary');
    }
  });
  const display = document.getElementById('current-phase-display');
  if (display) {
    const labels = { BEFORE: '導入（BEFORE）', AFTER: '振り返り（AFTER）', CLOSED: '終了' };
    display.innerText = labels[phase] || phase;
  }
}

/**
 * Active Session Info Display (Teacher)
 */
function updateActiveSessionInfo() {
  const infoEl = document.getElementById('active-session-info');
  if (!infoEl) return;
  if (currentSession) {
    infoEl.innerHTML = `<div class="alert alert-success py-2 mb-0">
      <i class="bi bi-broadcast"></i> <strong>${escapeHtml(currentSession.title)}</strong>
      <span class="badge bg-light text-dark ms-2">${escapeHtml(currentSession.inputType)}</span>
    </div>`;
    setPhaseControlsEnabled(true);
  } else {
    infoEl.innerHTML = `<div class="alert alert-secondary py-2 mb-0">
      <i class="bi bi-pause-circle"></i> 授業が開始されていません
    </div>`;
    setPhaseControlsEnabled(false);
  }
}

function setPhaseControlsEnabled(enabled) {
  ['btn-phase-BEFORE', 'btn-phase-AFTER', 'btn-phase-CLOSED'].forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.disabled = !enabled;
  });
}

/**
 * Reflection (Student - AFTER Phase)
 */
function showReflectionView() {
  if (!currentSession || !currentUser) return;

  // セッションの入力モードに応じたUI表示
  const sliderDiv = document.getElementById('reflection-input-slider');
  const tagsDiv = document.getElementById('reflection-input-tags');
  sliderDiv.classList.add('d-none');
  tagsDiv.classList.add('d-none');

  if (currentSession.inputType === 'SLIDER') {
    sliderDiv.classList.remove('d-none');
    document.getElementById('reflection-slider-label-min').innerText = currentSession.options.minLabel || 'A';
    document.getElementById('reflection-slider-label-max').innerText = currentSession.options.maxLabel || 'B';
  } else if (currentSession.inputType === 'TAGS') {
    tagsDiv.classList.remove('d-none');
    const container = document.getElementById('reflection-tags-container');
    const tags = currentSession.options.tags || ['うれしい', 'かなしい', 'くやしい', '迷う'];
    buildTagButtons(container, tags, selectReflectionTag);
  }

  // 振り返りヘッダーに授業タイトルを表示
  const reflectionTitle = document.getElementById('reflection-session-title');
  if (reflectionTitle) reflectionTitle.innerText = currentSession.title;

  // BEFOREの回答を取得して表示
  runGoogleScript('getStudentLogs', currentSession.id, currentUser.id)
    .then(logs => {
      const beforeLog = logs.find(l => l.phase === 'BEFORE');
      const el = document.getElementById('reflection-before');
      if (beforeLog) {
        let display = '';
        if (currentSession.inputType === 'SLIDER') {
          display = `<div class="mb-1">位置: <span class="badge bg-primary">${escapeHtml(beforeLog.value)}</span> / 100</div>`;
        } else if (currentSession.inputType === 'TAGS') {
          display = `<div class="mb-1">気持ち: <span class="badge bg-primary">${escapeHtml(beforeLog.value)}</span></div>`;
        }
        if (beforeLog.text) {
          display += `<div class="mt-1">「${escapeHtml(beforeLog.text)}」</div>`;
        }
        el.innerHTML = display;
      } else {
        el.innerHTML = '<span class="text-muted">導入時の記録がありません</span>';
      }
    })
    .catch(err => {
      console.error(err);
      document.getElementById('reflection-before').innerHTML = '<span class="text-muted">読み込みに失敗しました</span>';
    });

  showView('view-reflection');
}

let selectedReflectionTag = '';

function selectReflectionTag(el) {
  document.querySelectorAll('#reflection-tags-container .emotion-tag').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  selectedReflectionTag = el.innerText;
}

function updateReflectionSliderDisplay(val) {
  document.getElementById('reflection-slider-value').innerText = val;
}

function submitReflection() {
  if (!currentUser || !currentSession) return;

  // 重複送信ガード
  if (submittedPhases.has('AFTER')) {
    Swal.fire('もう送ってあるよ', '振り返りは送信ずみです', 'info');
    return;
  }

  const text = document.getElementById('reflection-text').value;
  let val = 0;

  if (currentSession.inputType === 'SLIDER') {
    val = Number(document.getElementById('reflection-slider').value);
  } else if (currentSession.inputType === 'TAGS') {
    if (!selectedReflectionTag) {
      Swal.fire('気持ちを選んでね', '', 'warning');
      return;
    }
    val = selectedReflectionTag;
  }

  const payload = {
    sessionId: currentSession.id,
    studentId: currentUser.id,
    phase: 'AFTER',
    value: val,
    text: text
  };

  Swal.fire({ title: '送信中...', didOpen: () => Swal.showLoading() });

  runGoogleScript('submitLog', payload)
    .then(() => {
      submittedPhases.add('AFTER');

      Swal.fire({
        icon: 'success',
        title: '振り返りを送りました！',
        timer: 1500,
        showConfirmButton: false
      });
      showView('view-done');
    })
    .catch(showError);
}

/**
 * Student Phase Polling
 */
function checkPhaseUpdate() {
  if (localStorage.getItem('isTeacher') === 'true') return;
  if (!currentSession) return;
  // 送信完了・記録閲覧中はポーリング不要
  if (currentViewId === 'view-done' || currentViewId === 'view-mylog') return;

  runGoogleScript('getInitialData')
    .then(response => {
      if (!response || !response.success || !response.activeSession) return;

      const serverPhase = response.activeSession.phase;
      if (serverPhase !== currentSession.phase) {
        currentSession.phase = serverPhase;
        currentPhase = serverPhase;

        if (serverPhase === 'AFTER' && !submittedPhases.has('AFTER')) {
          showReflectionView();
        }
      }
    })
    .catch(() => {}); // ポーリングエラーは静かに無視
}

/**
 * Roster Management (Teacher)
 */
function renderRoster(users) {
  const container = document.getElementById('roster-list');
  if (!container) return;

  if (!users || users.length === 0) {
    container.innerHTML = '<p class="text-muted small">名簿が空です</p>';
    return;
  }

  container.innerHTML = users.map(u =>
    `<div class="d-flex justify-content-between align-items-center border-bottom py-1">
       <span>${escapeHtml(u.name)} <small class="text-muted">(${escapeHtml(u.ruby)})</small></span>
       <button class="btn btn-sm btn-outline-danger" onclick="removeStudent('${escapeHtml(u.id)}', '${escapeHtml(u.name)}')">
         <i class="bi bi-trash"></i>
       </button>
     </div>`
  ).join('');
}

function addNewStudent() {
  const name = document.getElementById('new-student-name').value.trim();
  const ruby = document.getElementById('new-student-ruby').value.trim();
  if (!name) {
    Swal.fire('名前を入力してください', '', 'warning');
    return;
  }

  Swal.fire({ title: '追加中...', didOpen: () => Swal.showLoading() });

  runGoogleScript('addStudent', name, ruby || '')
    .then(result => {
      if (result && result.success) {
        document.getElementById('new-student-name').value = '';
        document.getElementById('new-student-ruby').value = '';
        Swal.fire({ icon: 'success', title: '追加しました', timer: 1000, showConfirmButton: false });
        // 名簿を再読込
        reloadRoster();
      }
    })
    .catch(showError);
}

function removeStudent(studentId, name) {
  Swal.fire({
    title: `${name} を削除しますか？`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: '削除',
    cancelButtonText: 'キャンセル'
  }).then(result => {
    if (result.isConfirmed) {
      runGoogleScript('deleteStudent', studentId)
        .then(() => {
          Swal.fire({ icon: 'success', title: '削除しました', timer: 1000, showConfirmButton: false });
          reloadRoster();
        })
        .catch(showError);
    }
  });
}

function reloadRoster() {
  runGoogleScript('getInitialData')
    .then(response => {
      if (response && response.success) {
        renderRoster(response.users);
      }
    })
    .catch(console.error);
}

/**
 * Chart.js Logic
 */
function simpleHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash);
}

function initChart() {
  const ctx = document.getElementById('scatterChart').getContext('2d');
  scatterChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: '導入（BEFORE）',
          data: [],
          backgroundColor: 'rgba(26, 115, 232, 0.6)',
          pointRadius: 8
        },
        {
          label: '振り返り（AFTER）',
          data: [],
          backgroundColor: 'rgba(234, 67, 53, 0.6)',
          pointRadius: 8
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { min: 0, max: 100, title: { display: true, text: '意見の位置' } },
        y: { min: 0, max: 10, display: false }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const d = context.raw;
              let label = context.dataset.label + ': ';
              if (d.text) label += `「${d.text.substring(0, 30)}」`;
              return label;
            }
          }
        },
        legend: { display: true, position: 'top' }
      }
    }
  });
}

function loadScatterData() {
  if (!currentSession) return;

  runGoogleScript('getSessionLogs', currentSession.id)
    .then(logs => {
      if (!scatterChart) return;
      const beforeData = [];
      const afterData = [];
      logs.forEach(l => {
        const y = (simpleHash(l.logId || l.studentId || '') % 90) / 10 + 0.5;
        const point = { x: Number(l.value) || 0, y: y, text: l.text };
        if (l.phase === 'AFTER') {
          afterData.push(point);
        } else {
          beforeData.push(point);
        }
      });
      scatterChart.data.datasets[0].data = beforeData;
      scatterChart.data.datasets[1].data = afterData;
      scatterChart.update();
    })
    .catch(console.error);
}

// ポーリング開始（教師: 散布図更新 / 生徒: フェーズ変更検知）
setInterval(() => {
  if (localStorage.getItem('isTeacher') === 'true' && currentSession) {
    loadScatterData();
  } else {
    checkPhaseUpdate();
  }
}, 5000);

/**
 * AI Socrates (Gemini Integration)
 */
function requestAiFeedback(sessionTitle, text, inputType, value) {
  runGoogleScript('generateSocraticQuestion', sessionTitle, text, inputType, value)
    .then(result => {
      if (result && result.success && result.question) {
        const card = document.getElementById('ai-feedback-card');
        const textEl = document.getElementById('ai-feedback-text');
        if (card && textEl) {
          textEl.innerText = result.question;
          card.classList.remove('d-none');
        }
      }
    })
    .catch(() => {}); // AIフィードバックは失敗しても無視
}

/**
 * Gemini API Key Management (Teacher)
 */
function saveApiKey() {
  const key = document.getElementById('gemini-api-key-input').value.trim();
  runGoogleScript('saveGeminiApiKey', key)
    .then(() => {
      Swal.fire({ icon: 'success', title: '保存しました', timer: 1000, showConfirmButton: false });
      checkGeminiStatus();
    })
    .catch(showError);
}

function checkGeminiStatus() {
  runGoogleScript('hasGeminiApiKey')
    .then(result => {
      const el = document.getElementById('gemini-status');
      if (el) {
        el.innerHTML = result && result.hasKey
          ? '<span class="text-success"><i class="bi bi-check-circle"></i> APIキー設定済み（AI問いかけ機能ON）</span>'
          : '<span class="text-muted"><i class="bi bi-x-circle"></i> 未設定（設定するとAI問いかけ機能が有効になります）</span>';
      }
    })
    .catch(() => {});
}

/**
 * Student Summaries (Teacher Report)
 */
function loadStudentSummaries() {
  if (!currentSession) {
    Swal.fire('授業が選択されていません', '', 'warning');
    return;
  }
  const container = document.getElementById('summary-container');
  container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> 読み込み中...</div>';

  runGoogleScript('getStudentSummaries', currentSession.id)
    .then(summaries => {
      if (!summaries || summaries.length === 0) {
        container.innerHTML = '<p class="text-muted small">まだ回答がありません</p>';
        return;
      }
      container.innerHTML = summaries.map(s => {
        const before = s.before ? `<span class="badge bg-primary me-1">${escapeHtml(s.before.value)}</span>${escapeHtml(s.before.text || '')}` : '<span class="text-muted">未回答</span>';
        const after = s.after ? `<span class="badge bg-danger me-1">${escapeHtml(s.after.value)}</span>${escapeHtml(s.after.text || '')}` : '<span class="text-muted">未回答</span>';
        const changed = s.before && s.after && s.before.value !== s.after.value;
        return `<div class="border rounded p-2 mb-2 ${changed ? 'border-warning' : ''}">
          <div class="fw-bold">${escapeHtml(s.name)} <small class="text-muted">(${escapeHtml(s.ruby)})</small> ${changed ? '<span class="badge bg-warning text-dark">変化あり</span>' : ''}</div>
          <div class="small mt-1"><span class="text-primary">導入:</span> ${before}</div>
          <div class="small"><span class="text-danger">振り返り:</span> ${after}</div>
        </div>`;
      }).join('');
    })
    .catch(showError);
}

/**
 * My Log (Student History)
 */
function showMyLog() {
  if (!currentUser) return;
  showView('view-mylog');

  runGoogleScript('getAllSessions')
    .then(sessions => {
      if (!sessions || sessions.length === 0) {
        document.getElementById('mylog-list').innerHTML = '<p class="text-muted">まだ記録がありません</p>';
        return;
      }
      // 各セッションの自分のログを取得
      const promises = sessions.map(session =>
        runGoogleScript('getStudentLogs', session.id, currentUser.id)
          .then(logs => ({ session, logs }))
      );
      Promise.all(promises).then(results => {
        const html = results
          .filter(r => r.logs.length > 0)
          .map(r => {
            const s = r.session;
            const beforeLog = r.logs.find(l => l.phase === 'BEFORE');
            const afterLog = r.logs.find(l => l.phase === 'AFTER');
            const dateStr = s.date ? new Date(s.date).toLocaleDateString('ja-JP') : '';
            let body = '';
            if (beforeLog) {
              body += `<div class="small"><span class="badge bg-primary">導入</span> ${escapeHtml(beforeLog.value || '')} ${beforeLog.text ? '「' + escapeHtml(beforeLog.text) + '」' : ''}</div>`;
            }
            if (afterLog) {
              body += `<div class="small mt-1"><span class="badge bg-danger">振り返り</span> ${escapeHtml(afterLog.value || '')} ${afterLog.text ? '「' + escapeHtml(afterLog.text) + '」' : ''}</div>`;
            }
            return `<div class="card mb-2"><div class="card-body py-2">
              <div class="fw-bold">${escapeHtml(s.title)} <small class="text-muted">${escapeHtml(dateStr)}</small></div>
              ${body}
            </div></div>`;
          }).join('');
        document.getElementById('mylog-list').innerHTML = html || '<p class="text-muted">まだ記録がありません</p>';
      });
    })
    .catch(err => {
      console.error(err);
      document.getElementById('mylog-list').innerHTML = '<p class="text-muted">読み込みに失敗しました</p>';
    });
}

/**
 * GAS Wrapper (GIGA Standard)
 */
function runGoogleScript(funcName, ...args) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      [funcName](...args);
  });
}

function showError(err) {
  console.error(err);
  Swal.fire({
    icon: 'error',
    title: 'エラー',
    text: '通信に失敗しました: ' + err.toString()
  });
}
</script>
