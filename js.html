<script>
  /**
   * =================================================================
   * 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»çŠ¶æ…‹ç®¡ç† (GLOBAL STATE)
   * =================================================================
   */
  let currentUser = null;
  let currentSession = null;
  let currentPhase = 'BEFORE'; // æˆæ¥­ãƒ•ã‚§ãƒ¼ã‚º: BEFORE(å°å…¥), AFTER(å±•é–‹/ã¾ã¨ã‚)
  let scatterChart = null;     // æ•™å¸«ç”¨: æ•£å¸ƒå›³ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
  let loadingTimeout = null;   // èª­ã¿è¾¼ã¿ç›£è¦–ç”¨ã‚¿ã‚¤ãƒãƒ¼
  let isPageVisible = true;    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ã®è¡¨ç¤ºçŠ¶æ…‹ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°åˆ¶å¾¡ç”¨ï¼‰
  let isAutoLogin = false;     // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ©ã‚°

  // Google Drive Picker State
  let pickerModal = null;
  let currentPickerFolderId = null;
  let parentPickerFolderId = null;


  /**
   * =================================================================
   * 2. ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ãƒ»ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« (INITIALIZATION)
   * =================================================================
   */
  document.addEventListener('visibilitychange', () => {
    isPageVisible = !document.hidden;
    if (isPageVisible) {
      // ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸã‚‰å³åº§ã«çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
      if (localStorage.getItem('isTeacher') !== 'true') {
        checkPhaseUpdate();
      }
    }
  });
  document.addEventListener('DOMContentLoaded', () => {
    // 1. ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒãƒƒãƒˆ
    loadingTimeout = setTimeout(() => {
      const loader = document.getElementById('loading');
      if (loader && !loader.classList.contains('d-none')) {
        loader.innerHTML = `
        <div class="alert alert-warning">
          <p>èª­ã¿è¾¼ã¿ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚</p>
          <button class="btn btn-sm btn-outline-dark" onclick="resetApp()">å†èª­ã¿è¾¼ã¿</button>
        </div>`;
      }
    }, 15000);

    // ã‚¢ãƒ—ãƒªãƒ•ãƒ­ãƒ¼é–‹å§‹
    initAppFlow();

    // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ (5ç§’é–“éš”)
    setInterval(() => {
      if (!isPageVisible) return; // ã‚¿ãƒ–éè¡¨ç¤ºæ™‚ã¯åœæ­¢
      checkPhaseUpdate();
    }, 5000);
  });

  /**
   * UI Logic (Safe Transition)
   */
  function showView(viewId) {
    // ã™ã¹ã¦ã®ãƒ“ãƒ¥ãƒ¼ã‚’éš ã™
    const allViews = document.querySelectorAll('[id^="view-"]');
    allViews.forEach(el => el.classList.add('d-none'));

    // æŒ‡å®šã•ã‚ŒãŸãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
    const target = document.getElementById(viewId);
    if (target) {
      target.classList.remove('d-none');
      target.classList.add('fade-in');
    } else {
      // ä¸‡ãŒä¸€IDãŒé–“é•ã£ã¦ã„ãŸã‚‰å¾…æ©Ÿç”»é¢ã‚’å‡ºã™ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆã‚¢ã‚¦ãƒˆé˜²æ­¢ï¼‰
      console.warn(`View ID "${viewId}" not found. Fallback to waiting.`);
      const fallback = document.getElementById('view-waiting');
      if (fallback) fallback.classList.remove('d-none');
    }
  }

  /**
   * =================================================================
   * 4. ç”Ÿå¾’ç”¨æ©Ÿèƒ½ (STUDENT FUNCTIONS)
   * =================================================================
   */
  function login(autoUid) {
    let uid = autoUid;
    if (!uid) {
      const select = document.getElementById('student-select');
      uid = select.value;
      if (!uid) {
        Swal.fire('åå‰ã‚’é¸ã‚“ã§ã­', '', 'warning');
        return;
      }
    }

    localStorage.setItem('studentId', uid);
    currentUser = { id: uid };

    // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ã€Œåå‰ã‚’å¤‰ãˆã‚‹ã€ãƒªãƒ³ã‚¯ã‚’éè¡¨ç¤º
    const btnLogout = document.getElementById('btn-logout-student');
    if (btnLogout) {
      btnLogout.classList.toggle('d-none', isAutoLogin);
    }

    // æˆæ¥­æœ‰ç„¡ã§åˆ†å²
    if (currentSession) {
      if (currentPhase === 'AFTER') {
        showReflectionView();
      } else {
        showView('view-entry');
      }
    } else {
      showView('view-waiting');
    }
  }

  function setupSessionUI(session) {
    const titleEl = document.getElementById('session-title');
    if (titleEl) titleEl.innerText = session.title;

    // PatternRendererã«ã‚ˆã‚‹å‹•çš„æç”»
    const container = document.getElementById('pattern-ui-container');
    if (!container) {
      console.error('pattern-ui-container not found');
      return;
    }

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ¼ã‚¹
    let opts = {};
    try {
      opts = typeof session.options === 'string' ? JSON.parse(session.options) : session.options;
    } catch (e) {
      console.error('Failed to parse options', e);
    }

    // Render
    patternRenderer.render(session.inputType, container, opts, 'INPUT');

    // èƒŒæ™¯è‰²èª¿æ•´ç­‰ã®ãŸã‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯çš„ãªå‡¦ç†ãŒå¿…è¦ãªã‚‰ã“ã“ã§è¡Œã†
    // ä¾‹: Sliderã®å ´åˆã®èƒŒæ™¯è‰²åŒæœŸãªã© (PatternRendererå†…ã§å®Œçµã•ã›ã‚‹ã®ãŒç†æƒ³ã ãŒã€äº’æ›æ€§ç¶­æŒã®ãŸã‚)
    if (session.inputType === 'SLIDER') {
      const slider = document.getElementById('pattern-slider');
      if (slider) {
        // åˆæœŸã‚«ãƒ©ãƒ¼è¨­å®šã®ãƒ­ã‚¸ãƒƒã‚¯å†åˆ©ç”¨ (IDãŒå¤‰ã‚ã£ãŸã®ã§æ³¨æ„)
        // patternRenderer.renderSlider ã§ oninput ã«åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹ã®ã§ã€åŸºæœ¬ã¯ä¸è¦ã ãŒ
        // åˆæœŸè¡¨ç¤ºæ™‚ã®è‰²è¨­å®šãŒå¿…è¦ãªã‚‰ dispatchEvent ã™ã‚‹
        slider.dispatchEvent(new Event('input'));
      }
    }
  }

  // updateSliderColor, selectTag ã¯ PatternRenderer ã«ç§»è¡Œæ¸ˆã¿ã®ãŸã‚å‰Šé™¤

  /**
   * Action: é€ä¿¡
   */
  /**
   * Fullscreen Opinion View
   */
  function showOpinionFullscreen() {
    const overlay = document.getElementById('fullscreen-opinions');
    if (!overlay) return;
    overlay.classList.remove('d-none');

    const content = document.getElementById('fullscreen-opinion-content');
    content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-3 text-muted fs-5">èª­ã¿è¾¼ã¿ä¸­...</p></div>';

    loadClassOpinionsFullscreen();
  }

  function closeOpinionFullscreen() {
    const overlay = document.getElementById('fullscreen-opinions');
    if (overlay) overlay.classList.add('d-none');
  }

  /**
   * Dialogue Mode (å¯¾è©±ãƒ¢ãƒ¼ãƒ‰)
   * å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œ: å›ç­”ã«åŸºã¥ã„ãŸè‰²ã§ç”»é¢ã‚’æŸ“ã‚ã€æ•™å®¤å†…ã§è‰²ã®é•ã†å‹é”ã‚’æ¢ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
   */
  function getDialogueColor(patternType, value, options) {
    let opts = {};
    try {
      opts = typeof options === 'string' ? JSON.parse(options) : (options || {});
    } catch (e) { }

    switch (patternType) {
      case 'SLIDER': {
        // 0=é’(210Â°), 50=ç·‘(105Â°), 100=èµ¤(0Â°) ã®é€£ç¶šã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        const v = Number(value) || 50;
        const hue = 210 - (v / 100) * 210;
        return `hsl(${hue}, 80%, 48%)`;
      }
      case 'TAGS': {
        // ã‚¿ã‚°ã”ã¨ã«é®®ã‚„ã‹ãªå›ºå®šè‰²
        const tagColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22'];
        const tags = opts.tags || [];
        const idx = tags.indexOf(String(value));
        return tagColors[idx >= 0 ? idx % tagColors.length : Math.abs(String(value).split('').reduce((h, c) => ((h << 5) - h) + c.charCodeAt(0), 0)) % tagColors.length];
      }
      case 'QUADRANT': {
        // 4è±¡é™ã§æ˜ç¢ºã«ç•°ãªã‚‹è‰²ï¼ˆä½ç½®ã®å¼·ã•ã§å½©åº¦å¤‰åŒ–ï¼‰
        let val = value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        const x = Number(val?.x) || 0;
        const y = Number(val?.y) || 0;
        const dist = Math.min(Math.sqrt(x * x + y * y) / 100, 1);
        const sat = 55 + dist * 35;
        if (x >= 0 && y >= 0) return `hsl(350, ${sat}%, 50%)`; // å³ä¸Š: èµ¤
        if (x < 0 && y >= 0) return `hsl(210, ${sat}%, 48%)`;  // å·¦ä¸Š: é’
        if (x < 0 && y < 0) return `hsl(145, ${sat}%, 42%)`;   // å·¦ä¸‹: ç·‘
        return `hsl(40, ${sat}%, 50%)`;                          // å³ä¸‹: æ©™
      }
      case 'RANKING': {
        // 1ä½ã«é¸ã‚“ã é …ç›®ã”ã¨ã«å›ºå®šè‰²
        let val = value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        const top = val?.items?.[0] || '';
        const items = opts.items || [];
        const idx = items.indexOf(top);
        const rankColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e'];
        return rankColors[idx >= 0 ? idx % rankColors.length : 0];
      }
      case 'CURVE': {
        // æ›²ç·šå…¨ä½“ã®å¹³å‡å€¤ã§ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä½=é’, é«˜=èµ¤ï¼‰
        let val = value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        if (val?.data && val.data.length > 0) {
          const avg = val.data.reduce((s, d) => s + d.value, 0) / val.data.length;
          const hue = 210 - (avg / 100) * 210;
          return `hsl(${hue}, 80%, 48%)`;
        }
        return '#6c757d';
      }
      case 'MANDALA': {
        // åŸ‹ã‚ãŸæ•°ã§ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå°‘ãªã„=é’, å¤šã„=èµ¤ï¼‰
        let val = value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        const count = val?.items ? val.items.filter(v => v && v.trim()).length : 0;
        const hue = 210 - (count / 8) * 210;
        return `hsl(${hue}, 75%, 48%)`;
      }
      case 'ACTION': {
        return '#27ae60';
      }
      default:
        return '#6c757d';
    }
  }

  function getDialogueLabel(patternType, value, options) {
    let opts = {};
    try {
      opts = typeof options === 'string' ? JSON.parse(options) : (options || {});
    } catch (e) { }

    const badge = (text) => `<span class="badge bg-white bg-opacity-25 fs-4 px-4 py-2 shadow-sm">${text}</span>`;

    switch (patternType) {
      case 'SLIDER': {
        const v = Number(value) || 50;
        const minL = opts.minLabel || 'A';
        const maxL = opts.maxLabel || 'B';
        return badge(`${v} / 100`) + `<div class="mt-2 small" style="opacity:0.8;">${minL} â† â†’ ${maxL}</div>`;
      }
      case 'TAGS':
        return badge(value);
      case 'QUADRANT': {
        let val = value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        const xL = opts.xAxisLabel || ['å·¦', 'å³'];
        const yL = opts.yAxisLabel || ['ä¸‹', 'ä¸Š'];
        const x = val?.x || 0;
        const y = val?.y || 0;
        const xDir = x >= 0 ? xL[1] : xL[0];
        const yDir = y >= 0 ? yL[1] : yL[0];
        return badge(`${yDir}ãƒ»${xDir}`);
      }
      case 'RANKING': {
        let val = value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        const top = val?.items?.[0] || '-';
        return badge(`1ä½: ${top}`);
      }
      case 'CURVE':
        return badge('å¿ƒæƒ…æ›²ç·š');
      case 'MANDALA': {
        let val = value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        const count = val?.items ? val.items.filter(v => v && v.trim()).length : 0;
        return badge(`${count}å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰`);
      }
      case 'ACTION': {
        let val = value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        return badge(val?.what || 'è¡Œå‹•å®£è¨€');
      }
      default:
        return badge(String(value));
    }
  }

  function showDialogueMode(value) {
    if (!currentSession) return;

    const color = getDialogueColor(currentSession.inputType, value, currentSession.options);
    const label = getDialogueLabel(currentSession.inputType, value, currentSession.options);

    const card = document.getElementById('dialogue-mode-card');
    const beacon = document.getElementById('dialogue-beacon');
    const valueDisplay = document.getElementById('dialogue-value-display');

    if (card) {
      card.classList.remove('d-none');
      card.dataset.color = color;
      card.dataset.label = label;
    }
    if (beacon) beacon.style.background = color;
    if (valueDisplay) valueDisplay.innerHTML = label;
  }

  function toggleDialogueFullscreen() {
    const card = document.getElementById('dialogue-mode-card');
    const fsOverlay = document.getElementById('dialogue-fullscreen');
    const fsBeacon = document.getElementById('dialogue-fs-beacon');
    const fsValue = document.getElementById('dialogue-fs-value');

    if (!card || !fsOverlay) return;

    fsBeacon.style.background = card.dataset.color || '#6c757d';
    if (fsValue) fsValue.innerHTML = card.dataset.label || '';
    fsOverlay.classList.remove('d-none');
  }

  function closeDialogueFullscreen() {
    const fsOverlay = document.getElementById('dialogue-fullscreen');
    if (fsOverlay) fsOverlay.classList.add('d-none');
  }

  function loadClassOpinionsFullscreen() {
    if (!currentSession) return;

    const content = document.getElementById('fullscreen-opinion-content');

    runGoogleScript('getAnonymousOpinions', currentSession.id)
      .then(opinions => {
        if (!opinions || opinions.length === 0) {
          content.innerHTML = '<div class="text-center text-muted fs-4 py-5"><i class="bi bi-chat-dots d-block fs-1 mb-3"></i>ã¾ã æ„è¦‹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        // ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã§ãƒ•ã‚£ãƒ«ã‚¿
        const filtered = opinions.filter(o => o.phase === currentPhase);

        if (filtered.length === 0) {
          content.innerHTML = '<div class="text-center text-muted fs-4 py-5"><i class="bi bi-chat-dots d-block fs-1 mb-3"></i>ã“ã®å ´é¢ã®æ„è¦‹ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ¼ã‚¹
        let opts = {};
        try {
          opts = typeof currentSession.options === 'string' ? JSON.parse(currentSession.options) : (currentSession.options || {});
        } catch (e) { }

        // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æœ€é©åŒ–è¡¨ç¤º
        patternRenderer.renderOpinionListFullscreen(currentSession.inputType, content, filtered, opts);
      })
      .catch(err => {
        content.innerHTML = '<div class="text-center text-danger fs-5 py-5"><i class="bi bi-exclamation-triangle d-block fs-1 mb-3"></i>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      });
  }

  function submitOpinion() {
    if (!currentUser || !currentSession) return;

    const text = document.getElementById('input-text').value;

    // PatternRendererã‹ã‚‰å€¤ã‚’çµ±ä¸€å–å¾—
    const val = patternRenderer.getValue();

    if (val === null || val === undefined || val === '') {
      Swal.fire('å…¥åŠ›ã‚’ç¢ºèªã—ã¦ã­', '', 'warning');
      return;
    }

    const payload = {
      sessionId: currentSession.id,
      studentId: currentUser.id,
      phase: currentPhase,
      value: (typeof val === 'object') ? JSON.stringify(val) : val,
      text: text
    };

    Swal.fire({ title: 'é€ä¿¡ä¸­...', didOpen: () => Swal.showLoading() });

    runGoogleScript('submitLog', payload)
      .then(() => {
        Swal.fire({
          icon: 'success',
          title: 'é€ã‚Šã¾ã—ãŸï¼',
          text: 'å‹é”ã®æ„è¦‹ã‚‚è¦‹ã¦ã¿ã‚ˆã†',
          timer: 1500,
          showConfirmButton: false
        });

        // å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œ: å¯¾è©±ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
        showDialogueMode(val);

        // é€ä¿¡å¾Œ: ã¿ã‚“ãªã®è€ƒãˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        const btnOpinion = document.getElementById('btn-opinion-share');
        if (btnOpinion) btnOpinion.classList.remove('d-none');

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('input-text').value = '';

        // AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’éåŒæœŸã§å–å¾—
        document.getElementById('ai-feedback-card').classList.add('d-none');
        if (currentSession) {
          requestAiFeedback(currentSession.title, text, currentSession.inputType, val);
        }
      })
      .catch(showError);
  }

  /**
   * Teacher Functions
   */
  function logoutTeacher() {
    localStorage.removeItem('isTeacher');
    resetApp();
  }

  function logoutStudent() {
    if (isAutoLogin) {
      Swal.fire('è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ä¸­', 'Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãŸã‚ã€åå‰ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚', 'info');
      return;
    }
    localStorage.removeItem('studentId');
    currentUser = null;
    showView('view-login');
  }


  function toggleTeacherMode() {
    const isT = localStorage.getItem('isTeacher') === 'true';
    if (isT) {
      if (confirm('å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')) {
        logoutTeacher();
      }
    } else {
      // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰èªè¨¼
      Swal.fire({
        title: 'å…ˆç”Ÿç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
        input: 'password',
        inputAttributes: {
          autocapitalize: 'off'
        },
        showCancelButton: true,
        confirmButtonText: 'ãƒ­ã‚°ã‚¤ãƒ³',
        showLoaderOnConfirm: true,
        preConfirm: (pass) => {
          return runGoogleScript('checkTeacherPassword', pass)
            .then(result => {
              if (!result.success) {
                throw new Error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
              }
              return true;
            })
            .catch(error => {
              Swal.showValidationMessage(
                `ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${error}`
              )
            })
        },
        allowOutsideClick: () => !Swal.isLoading()
      }).then((result) => {
        if (result.isConfirmed) {
          localStorage.setItem('isTeacher', 'true');
          resetApp(); // ãƒªãƒ­ãƒ¼ãƒ‰ã›ãšã«ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        }
      })
    }
  }

  function toggleSessionOptions() {
    const type = document.getElementById('new-session-type').value;
    document.getElementById('session-opts-slider').classList.toggle('d-none', type !== 'SLIDER');
    document.getElementById('session-opts-tags').classList.toggle('d-none', type !== 'TAGS');
    document.getElementById('session-opts-quadrant').classList.toggle('d-none', type !== 'QUADRANT');
    document.getElementById('session-opts-mandala').classList.toggle('d-none', type !== 'MANDALA');
    document.getElementById('session-opts-ranking').classList.toggle('d-none', type !== 'RANKING');
    document.getElementById('session-opts-curve').classList.toggle('d-none', type !== 'CURVE');
  }

  /**
   * =================================================================
   * 3. æˆæ¥­ç®¡ç† (TEACHER SESSION CONTROL)
   * =================================================================
   */
  function createNewSession() {
    const title = document.getElementById('new-session-title').value;
    if (!title) { Swal.fire('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥ã‚Œã¦ã­', '', 'warning'); return; }

    const type = document.getElementById('new-session-type').value;
    let options = {};

    if (type === 'SLIDER') {
      const minLabel = document.getElementById('opt-slider-min').value.trim() || 'è³›æˆ';
      const maxLabel = document.getElementById('opt-slider-max').value.trim() || 'åå¯¾';
      options = { minLabel: minLabel, maxLabel: maxLabel, tags: [] };
    } else if (type === 'TAGS') {
      const tagsStr = document.getElementById('opt-tags-list').value.trim();
      const tags = tagsStr ? tagsStr.split(/[,ã€ï¼Œ]/).map(t => t.trim()).filter(t => t) : ['å…±æ„Ÿ', 'ç–‘å•', 'ç´å¾—', 'é©šã'];
      options = { tags: tags };
    } else if (type === 'QUADRANT') {
      options = {
        xAxisLabel: [
          document.getElementById('opt-quad-xmin').value || 'å·¦',
          document.getElementById('opt-quad-xmax').value || 'å³'
        ],
        yAxisLabel: [
          document.getElementById('opt-quad-ymin').value || 'ä¸‹',
          document.getElementById('opt-quad-ymax').value || 'ä¸Š'
        ]
      };
    } else if (type === 'MANDALA') {
      options = {
        centerTheme: document.getElementById('opt-mandala-theme').value || 'ãƒ†ãƒ¼ãƒ'
      };
    } else if (type === 'RANKING') {
      const itemsStr = document.getElementById('opt-ranking-items').value.trim();
      const items = itemsStr ? itemsStr.split(/[,ã€ï¼Œ]/).map(t => t.trim()).filter(t => t) : ['é …ç›®A', 'é …ç›®B', 'é …ç›®C'];
      options = { items: items };
    } else if (type === 'CURVE') {
      const scenesStr = document.getElementById('opt-curve-scenes').value.trim();
      const scenes = scenesStr ? scenesStr.split(/[,ã€ï¼Œ]/).map(t => t.trim()).filter(t => t) : ['ã¯ã˜ã‚', 'å±•é–‹', 'å±±å ´', 'çµæœ«'];
      options = { scenes: scenes };
    } else if (type === 'ACTION') {
      options = {}; // No config
    }

    Swal.fire({ title: 'æˆæ¥­ã‚’ä½œæˆä¸­...', didOpen: () => Swal.showLoading() });

    runGoogleScript('createSession', title, type, JSON.stringify(options))
      .then(() => {
        Swal.fire({
          icon: 'success',
          title: 'ä½œæˆã—ã¾ã—ãŸ',
          text: 'ç”Ÿå¾’ã«ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‚ˆã†ä¼ãˆã¦ãã ã•ã„',
        });
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ•£å¸ƒå›³ã‚’æ›´æ–°
        runGoogleScript('getInitialData').then(response => {
          if (response && response.success && response.activeSession) {
            currentSession = response.activeSession;
            loadScatterData();
          }
        });
      })
      .catch(showError);
  }

  /**
   * Phase Management (Teacher)
   */
  function changePhase(newPhase) {
    if (!currentSession) {
      Swal.fire('æˆæ¥­ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', '', 'warning');
      return;
    }

    if (newPhase === 'CLOSED') {
      Swal.fire({
        title: 'æˆæ¥­ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ',
        text: 'ç”Ÿå¾’ã¯å…¥åŠ›ã§ããªããªã‚Šã¾ã™',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'çµ‚äº†ã™ã‚‹',
        cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
      }).then(result => {
        if (result.isConfirmed) {
          runGoogleScript('closeSession', currentSession.id)
            .then(() => {
              currentSession = null;
              updatePhaseButtons('CLOSED');
              Swal.fire('æˆæ¥­ã‚’çµ‚äº†ã—ã¾ã—ãŸ', '', 'success');
            })
            .catch(showError);
        }
      });
      return;
    }

    Swal.fire({ title: 'ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ä¸­...', didOpen: () => Swal.showLoading() });

    runGoogleScript('updateSessionPhase', currentSession.id, newPhase)
      .then(result => {
        if (result && result.success) {
          currentSession.phase = newPhase;
          updatePhaseButtons(newPhase);
          Swal.fire({
            icon: 'success',
            title: 'ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´å®Œäº†',
            text: newPhase === 'BEFORE' ? 'å°å…¥ãƒ•ã‚§ãƒ¼ã‚ºã§ã™' : 'æŒ¯ã‚Šè¿”ã‚Šãƒ•ã‚§ãƒ¼ã‚ºã§ã™',
            timer: 1500,
            showConfirmButton: false
          });
        }
      })
      .catch(showError);
  }

  function updatePhaseButtons(phase) {
    const phases = ['BEFORE', 'AFTER', 'CLOSED'];
    phases.forEach(p => {
      // Class Mode Buttons
      const btn = document.getElementById('btn-phase-' + p + '-class');
      if (!btn) return;

      if (p === phase) {
        btn.classList.remove('btn-outline-primary', 'btn-outline-danger');
        btn.classList.add(p === 'CLOSED' ? 'btn-danger' : 'btn-primary');
        btn.classList.remove('bg-white'); // Ensure active state is solid color
      } else {
        btn.classList.remove('btn-primary', 'btn-danger');
        btn.classList.add(p === 'CLOSED' ? 'btn-outline-danger' : 'btn-outline-primary');
        btn.classList.add('bg-white'); // Keep background white for outline
      }
    });

    const labels = { BEFORE: 'å°å…¥ï¼ˆBEFOREï¼‰', AFTER: 'æŒ¯ã‚Šè¿”ã‚Šï¼ˆAFTERï¼‰', CLOSED: 'çµ‚äº†' };
    const displayClass = document.getElementById('current-phase-display-class');
    if (displayClass) displayClass.innerText = labels[phase] || phase;
  }

  function switchTeacherMode(mode) {
    ['prep', 'class', 'history'].forEach(m => {
      const btn = document.getElementById('btn-mode-' + m);
      if (btn) btn.classList.toggle('active', mode === m);
      const panel = document.getElementById('teacher-mode-' + m);
      if (panel) panel.classList.toggle('d-none', mode !== m);
    });

    if (mode === 'history') {
      loadHistoryDropdowns();
    }
  }

  /**
   * Reflection (Student - AFTER Phase)
   */
  function showReflectionView() {
    if (!currentSession || !currentUser) return;

    // PatternRendererç”¨ã‚³ãƒ³ãƒ†ãƒŠï¼ˆHTMLå´ã«å®šç¾©æ¸ˆã¿ï¼‰
    const pContainer = document.getElementById('reflection-pattern-renderer-host');
    if (!pContainer) return;
    pContainer.innerHTML = '';

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ¼ã‚¹
    let opts = {};
    try {
      opts = typeof currentSession.options === 'string' ? JSON.parse(currentSession.options) : currentSession.options;
    } catch (e) { }

    patternRenderer.render(currentSession.inputType, pContainer, opts, 'REFLECTION');

    // BEFOREã®å›ç­”ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    runGoogleScript('getStudentLogs', currentSession.id, currentUser.id)
      .then(logs => {
        const beforeLog = logs.find(l => l.phase === 'BEFORE');
        const el = document.getElementById('reflection-before');
        if (beforeLog) {
          let display = '';
          const val = beforeLog.value;

          if (currentSession.inputType === 'SLIDER') {
            display = `<div class="mb-1">ä½ç½®: <span class="badge bg-primary">${val}</span> / 100</div>`;
          } else if (currentSession.inputType === 'TAGS') {
            display = `<div class="mb-1">æ°—æŒã¡: <span class="badge bg-primary">${val}</span></div>`;
          } else if (currentSession.inputType === 'QUADRANT') {
            // JSONãƒ‘ãƒ¼ã‚¹
            let jsonVal = val;
            try { if (typeof val === 'string') jsonVal = JSON.parse(val); } catch (e) { }
            display = `<div class="mb-1">ä½ç½®: <span class="badge bg-primary">X:${jsonVal.x}, Y:${jsonVal.y}</span></div>`;
          } else if (currentSession.inputType === 'MANDALA') {
            let jsonVal = val;
            try { if (typeof val === 'string') jsonVal = JSON.parse(val); } catch (e) { }
            // ç°¡æ˜“è¡¨ç¤º: åŸ‹ã¾ã£ãŸæ•°ãªã©
            const count = jsonVal.items ? jsonVal.items.filter(v => v).length : 0;
            display = `<div class="mb-1">ãƒãƒ³ãƒ€ãƒ©: <span class="badge bg-primary">${count}å€‹</span> ã®è¦ç´ </div>`;
            // è©³ç´°è¡¨ç¤ºã¯é•·ããªã‚‹ã®ã§ã€ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ãªã©ã®UIãŒæœ¬æ¥ã¯è‰¯ã„ãŒã€ã“ã“ã§ã¯ä¸€éƒ¨è¡¨ç¤º
            if (count > 0) {
              const preview = jsonVal.items.filter(v => v).slice(0, 3).join(', ');
              display += `<div class="small text-muted text-truncate">${preview}...</div>`;
            }
          } else if (currentSession.inputType === 'ACTION') {
            let jsonVal = val;
            try { if (typeof val === 'string') jsonVal = JSON.parse(val); } catch (e) { }
            display = `<div class="mb-1"><span class="badge bg-success">è¡Œå‹•å®£è¨€</span></div>`;
            display += `<div class="small bg-light p-1 rounded">ã„ã¤: ${jsonVal.when}<br>èª°ã«: ${jsonVal.who}<br>ä½•ã‚’ã™ã‚‹: ${jsonVal.what}</div>`;
          } else if (currentSession.inputType === 'RANKING') {
            let jsonVal = val;
            try { if (typeof val === 'string') jsonVal = JSON.parse(val); } catch (e) { }
            if (jsonVal.items && jsonVal.items.length > 0) {
              display = `<div class="mb-1"><span class="badge bg-primary">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span></div>`;
              display += `<div class="small bg-light p-1 rounded">${jsonVal.items.map((item, i) => `${i + 1}. ${item}`).join('<br>')}</div>`;
            }
          } else if (currentSession.inputType === 'CURVE') {
            let jsonVal = val;
            try { if (typeof val === 'string') jsonVal = JSON.parse(val); } catch (e) { }
            if (jsonVal.data && jsonVal.data.length > 0) {
              display = `<div class="mb-1"><span class="badge bg-secondary">å¿ƒæƒ…æ›²ç·š</span></div>`;
              display += `<div class="small bg-light p-1 rounded">${jsonVal.data.map(d => `${d.label}: ${d.value}`).join(' â†’ ')}</div>`;
            }
          }
          if (beforeLog.text) {
            display += `<div class="mt-1">ã€Œ${beforeLog.text}ã€</div>`;
          }
          el.innerHTML = display;
        } else {
          el.innerHTML = '<span class="text-muted">å°å…¥æ™‚ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</span>';
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById('reflection-before').innerHTML = '<span class="text-muted">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
      });

    showView('view-reflection');
  }

  // selectReflectionTag, updateReflectionSliderDisplay ã¯ PatternRenderer ã«ç§»è¡Œæ¸ˆã¿ã®ãŸã‚å‰Šé™¤

  function submitReflection() {
    if (!currentUser || !currentSession) return;

    const text = document.getElementById('reflection-text').value;

    // PatternRendererã‹ã‚‰å€¤å–å¾—
    const val = patternRenderer.getValue();

    if (val === null || val === '') {
      Swal.fire('å…¥åŠ›ã‚’ç¢ºèªã—ã¦ã­', '', 'warning');
      return;
    }

    const payload = {
      sessionId: currentSession.id,
      studentId: currentUser.id,
      phase: 'AFTER',
      value: (typeof val === 'object') ? JSON.stringify(val) : val,
      text: text
    };

    Swal.fire({ title: 'é€ä¿¡ä¸­...', didOpen: () => Swal.showLoading() });

    runGoogleScript('submitLog', payload)
      .then(() => {
        Swal.fire({
          icon: 'success',
          title: 'æŒ¯ã‚Šè¿”ã‚Šã‚’é€ã‚Šã¾ã—ãŸï¼',
          timer: 1500,
          showConfirmButton: false
        });
        showView('view-done');
      })
      .catch(showError);
  }

  /**
   * Student Phase Polling
   */
  /**
 * Student Phase Polling
 */
  function checkPhaseUpdate() {
    if (localStorage.getItem('isTeacher') === 'true') return;

    runGoogleScript('getPollingData')
      .then(data => {
        // 1. ã‚±ãƒ¼ã‚¹: å¾…æ©Ÿä¸­ã ã£ãŸãŒã€æˆæ¥­ãŒå§‹ã¾ã£ãŸ
        if (!currentSession && data.activeSession) {
          console.log('Session started! Reloading...');
          resetApp(); // ã‚¢ãƒ—ãƒªå†åˆæœŸåŒ–ã§æˆæ¥­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
          return;
        }

        // 2. ã‚±ãƒ¼ã‚¹: æˆæ¥­ä¸­ã ã£ãŸãŒã€æˆæ¥­ãŒçµ‚ã‚ã£ãŸ (ã¾ãŸã¯æ¶ˆã•ã‚ŒãŸ)
        if (currentSession && !data.activeSession) {
          console.log('Session ended. Reloading...');
          resetApp(); // ã‚¢ãƒ—ãƒªå†åˆæœŸåŒ–ã§å¾…æ©Ÿç”»é¢ã¸
          return;
        }

        // 3. ã‚±ãƒ¼ã‚¹: IDãŒå¤‰ã‚ã£ãŸï¼ˆåˆ¥ã®æˆæ¥­ã«ãªã£ãŸï¼‰
        if (currentSession && data.activeSession && currentSession.id !== data.activeSession.id) {
          console.log('Session changed. Reloading...');
          resetApp();
          return;
        }

        // 4. ã‚±ãƒ¼ã‚¹: ãƒ•ã‚§ãƒ¼ã‚ºãŒå¤‰ã‚ã£ãŸ
        if (currentSession && data.activeSession) {
          const serverPhase = data.activeSession.phase;
          if (serverPhase !== currentSession.phase) {
            console.log(`Phase changed: ${currentSession.phase} -> ${serverPhase}`);
            currentSession.phase = serverPhase;
            currentPhase = serverPhase;

            // UIæ›´æ–°
            const phaseLabels = { BEFORE: 'ä»Šã®è€ƒãˆã‚’æ•™ãˆã¦ã­', AFTER: 'æŒ¯ã‚Šè¿”ã‚Šã®æ™‚é–“ã§ã™' };
            const pLabel = document.getElementById('phase-label');
            if (pLabel) pLabel.innerText = phaseLabels[serverPhase] || serverPhase;

            updatePhaseButtons && updatePhaseButtons(serverPhase); // ã‚‚ã—é–¢æ•°ãŒã‚ã‚Œã°

            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã‚’é–‰ã˜ã‚‹
            closeOpinionFullscreen();
            closeDialogueFullscreen();

            if (serverPhase === 'AFTER') {
              showReflectionView();
              Swal.fire({
                icon: 'info',
                title: 'æŒ¯ã‚Šè¿”ã‚Šã®æ™‚é–“ã§ã™',
                text: 'æˆæ¥­ã®ã¾ã¨ã‚ã‚’å…¥åŠ›ã—ã¾ã—ã‚‡ã†',
                timer: 2000,
                showConfirmButton: false
              });
            } else {
              // BEFOREã«æˆ»ã£ãŸå ´åˆãªã©
              showView('view-entry');
            }
          }
        }
      })
      .catch(() => { }); // ãƒãƒ¼ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
  }


  /**
   * Roster Management (Teacher)
   */
  function renderRoster(users) {
    const container = document.getElementById('roster-list');
    if (!container) return;

    if (!users || users.length === 0) {
      container.innerHTML = '<p class="text-muted small">åç°¿ãŒç©ºã§ã™</p>';
      return;
    }

    container.innerHTML = users.map(u => {
      const emailBadge = u.email
        ? `<span class="badge bg-success bg-opacity-25 text-success ms-2" title="${u.email}"><i class="bi bi-envelope-check"></i></span>`
        : `<span class="badge bg-warning bg-opacity-25 text-warning ms-2" title="ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š"><i class="bi bi-envelope-x"></i></span>`;
      return `<div class="d-flex justify-content-between align-items-center border-bottom py-2 px-2">
       <div>
         <span>${u.name} <small class="text-muted">(${u.ruby})</small></span>
         ${emailBadge}
         <small class="text-muted d-block" style="font-size:0.75rem;">${u.email || 'è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³æœªè¨­å®š'}</small>
       </div>
       <div class="d-flex gap-1">
         <button class="btn btn-sm btn-outline-primary" onclick="editStudentEmail('${u.id}', '${u.name}', '${u.email || ''}')" title="ãƒ¡ãƒ¼ãƒ«è¨­å®š">
           <i class="bi bi-envelope-at"></i>
         </button>
         <button class="btn btn-sm btn-outline-danger" onclick="removeStudent('${u.id}', '${u.name}')">
           <i class="bi bi-trash"></i>
         </button>
       </div>
     </div>`;
    }).join('');
  }

  function reloadRoster() {
    runGoogleScript('getStudents')
      .then(result => {
        if (result.success) {
          renderRoster(result.users);
        } else {
          showError(result.error);
        }
      })
      .catch(showError);
  }

  function addNewStudent() {
    const name = document.getElementById('new-student-name').value.trim();
    const ruby = document.getElementById('new-student-ruby').value.trim();
    const email = document.getElementById('new-student-email')?.value.trim() || '';
    if (!name) {
      Swal.fire('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', '', 'warning');
      return;
    }

    Swal.fire({ title: 'è¿½åŠ ä¸­...', didOpen: () => Swal.showLoading() });

    runGoogleScript('addStudent', name, ruby || '', email)
      .then(result => {
        if (result && result.success) {
          document.getElementById('new-student-name').value = '';
          document.getElementById('new-student-ruby').value = '';
          const emailInput = document.getElementById('new-student-email');
          if (emailInput) emailInput.value = '';
          Swal.fire({ icon: 'success', title: 'è¿½åŠ ã—ã¾ã—ãŸ', timer: 1000, showConfirmButton: false });
          reloadRoster();
        }
      })
      .catch(showError);
  }

  /**
   * å…ç«¥ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç·¨é›†ï¼ˆæ•™å¸«ç”¨ï¼‰
   */
  function editStudentEmail(studentId, name, currentEmail) {
    Swal.fire({
      title: `${name}ã®ãƒ¡ãƒ¼ãƒ«è¨­å®š`,
      input: 'email',
      inputLabel: 'Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
      inputValue: currentEmail,
      inputPlaceholder: 'example@school.ed.jp',
      showCancelButton: true,
      confirmButtonText: 'ä¿å­˜',
      cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      inputValidator: (value) => {
        // ç©ºæ¬„ã¯è¨±å¯ï¼ˆãƒ¡ãƒ¼ãƒ«è¨­å®šè§£é™¤ï¼‰
        if (value && !value.includes('@')) {
          return 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
        }
      }
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({ title: 'ä¿å­˜ä¸­...', didOpen: () => Swal.showLoading() });
        runGoogleScript('updateStudentEmail', studentId, result.value || '')
          .then(res => {
            if (res && res.success) {
              Swal.fire({ icon: 'success', title: 'ä¿å­˜ã—ã¾ã—ãŸ', timer: 1000, showConfirmButton: false });
              reloadRoster();
            } else {
              showError(res?.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          })
          .catch(showError);
      }
    });
  }
  /**
   * åç°¿ä¸€æ‹¬ç™»éŒ²
   */
  function registerBulkStudents() {
    Swal.fire({
      title: 'åç°¿ã®ä¸€æ‹¬ç™»éŒ²',
      input: 'textarea',
      inputLabel: 'Excelã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„',
      inputPlaceholder: 'å±±ç”° å¤ªéƒ\tã‚„ã¾ã  ãŸã‚ã†\ttaro@school.ed.jp\nä½è—¤ èŠ±å­\tã•ã¨ã† ã¯ãªã“\thanako@school.ed.jp',
      showCancelButton: true,
      confirmButtonText: 'ç™»éŒ²',
      cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      footer: 'â€»1è¡Œã«ã€Œåå‰ (ã‚¿ãƒ–) ãµã‚ŠãŒãª (ã‚¿ãƒ–) ãƒ¡ãƒ¼ãƒ«ã€ã®å½¢å¼ã€‚ãƒ¡ãƒ¼ãƒ«ã¯çœç•¥å¯ã€‚',
      preConfirm: (text) => {
        if (!text) return false;
        const lines = text.split('\n');
        const students = [];
        lines.forEach(line => {
          const parts = line.trim().split(/[\t,]+/); // Tab or Comma
          if (parts.length > 0 && parts[0]) {
            students.push({
              name: parts[0].trim(),
              ruby: parts[1] ? parts[1].trim() : '',
              email: parts[2] ? parts[2].trim() : ''
            });
          }
        });
        return students;
      }
    }).then((result) => {
      if (result.isConfirmed && result.value.length > 0) {
        const students = result.value;
        Swal.fire({ title: 'ç™»éŒ²ä¸­...', didOpen: () => Swal.showLoading() });

        runGoogleScript('addStudentBulk', students)
          .then(res => {
            if (res.success) {
              Swal.fire('å®Œäº†', `${res.count}äººã®ç”Ÿå¾’ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
              reloadRoster(); // Changed loadRoster() to reloadRoster() for consistency
            } else {
              showError(res.error);
            }
          })
          .catch(showError);
      }
    });
  }

  function removeStudent(studentId, name) {
    Swal.fire({
      title: `${name} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'å‰Šé™¤',
      cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
    }).then(result => {
      if (result.isConfirmed) {
        runGoogleScript('deleteStudent', studentId)
          .then(() => {
            Swal.fire({ icon: 'success', title: 'å‰Šé™¤ã—ã¾ã—ãŸ', timer: 1000, showConfirmButton: false });
            reloadRoster();
          })
          .catch(showError);
      }
    });
  }

  function reloadRoster() {
    runGoogleScript('getInitialData')
      .then(response => {
        if (response && response.success) {
          renderRoster(response.users);
        }
      })
      .catch(console.error);
  }

  /**
   * Chart.js Logic
   */
  function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash);
  }

  function initChart() {
    const ctx = document.getElementById('scatterChart').getContext('2d');
    scatterChart = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [
          {
            label: 'å°å…¥ï¼ˆBEFOREï¼‰',
            data: [],
            backgroundColor: 'rgba(26, 115, 232, 0.6)',
            pointRadius: 8
          },
          {
            label: 'æŒ¯ã‚Šè¿”ã‚Šï¼ˆAFTERï¼‰',
            data: [],
            backgroundColor: 'rgba(234, 67, 53, 0.6)',
            pointRadius: 8
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { min: 0, max: 100, title: { display: true, text: 'æ„è¦‹ã®ä½ç½®' } },
          y: { min: 0, max: 10, display: false }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function (context) {
                const d = context.raw;
                let label = context.dataset.label + ': ';
                if (d.text) label += `ã€Œ${d.text.substring(0, 30)}ã€`;
                return label;
              }
            }
          },
          legend: { display: true, position: 'top' }
        }
      }
    });
  }

  /**
   * ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®æ•™å¸«ç”¨å¯è¦–åŒ–ã‚’æç”»
   */
  function renderTeacherPatternView(logs) {
    const container = document.getElementById('chart-pattern-container');
    if (!container || !currentSession) return;

    const type = currentSession.inputType;
    let opts = {};
    try {
      opts = typeof currentSession.options === 'string' ? JSON.parse(currentSession.options) : (currentSession.options || {});
    } catch (e) { }

    const beforeLogs = logs.filter(l => l.phase === 'BEFORE');
    const afterLogs = logs.filter(l => l.phase === 'AFTER');

    let html = `<div class="small text-muted text-end mb-2">å›ç­”æ•°: å°å…¥ ${beforeLogs.length}ä»¶ / æŒ¯ã‚Šè¿”ã‚Š ${afterLogs.length}ä»¶</div>`;

    if (type === 'TAGS') {
      // TAGSã¯ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ã®ã‚¿ã‚°é›†è¨ˆã‚’æ£’ã‚°ãƒ©ãƒ•é¢¨ã«è¡¨ç¤º
      html += renderTagsTeacherView(beforeLogs, afterLogs);
    } else if (type === 'RANKING') {
      html += renderRankingTeacherView(beforeLogs, afterLogs, opts);
    } else if (type === 'CURVE') {
      html += `<div style="height: 250px;"><canvas id="teacher-curve-chart"></canvas></div>`;
      html += renderCurveTeacherTextView(beforeLogs, afterLogs);
    } else if (type === 'MANDALA') {
      html += renderMandalaTeacherView(beforeLogs, afterLogs);
    } else if (type === 'ACTION') {
      html += renderActionTeacherView(beforeLogs, afterLogs);
    }

    container.innerHTML = html;

    // CURVEã®å ´åˆã€ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
    if (type === 'CURVE') {
      setTimeout(() => renderCurveTeacherChart(beforeLogs, afterLogs, opts), 100);
    }
  }

  function renderTagsTeacherView(beforeLogs, afterLogs) {
    const beforeCounts = {};
    const afterCounts = {};
    beforeLogs.forEach(l => { beforeCounts[l.value] = (beforeCounts[l.value] || 0) + 1; });
    afterLogs.forEach(l => { afterCounts[l.value] = (afterCounts[l.value] || 0) + 1; });

    const allTags = [...new Set([...Object.keys(beforeCounts), ...Object.keys(afterCounts)])];
    const maxCount = Math.max(...Object.values(beforeCounts), ...Object.values(afterCounts), 1);

    let html = '<div class="mb-3">';
    allTags.forEach(tag => {
      const bCount = beforeCounts[tag] || 0;
      const aCount = afterCounts[tag] || 0;
      const bPct = Math.round((bCount / maxCount) * 100);
      const aPct = Math.round((aCount / maxCount) * 100);

      html += `<div class="mb-3">
        <div class="fw-bold small mb-1">${tag}</div>
        <div class="d-flex align-items-center gap-2 mb-1">
          <span class="badge bg-primary" style="min-width: 50px;">å°å…¥</span>
          <div class="progress flex-grow-1" style="height: 20px;">
            <div class="progress-bar bg-primary" style="width: ${bPct}%">${bCount}äºº</div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-danger" style="min-width: 50px;">æŒ¯è¿”ã‚Š</span>
          <div class="progress flex-grow-1" style="height: 20px;">
            <div class="progress-bar bg-danger" style="width: ${aPct}%">${aCount}äºº</div>
          </div>
        </div>
      </div>`;
    });
    html += '</div>';
    return html;
  }

  function renderRankingTeacherView(beforeLogs, afterLogs, opts) {
    const calcScores = (logs) => {
      const scores = {};
      logs.forEach(l => {
        let val = l.value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        if (val && val.items) {
          val.items.forEach((item, idx) => {
            if (!scores[item]) scores[item] = 0;
            scores[item] += Math.max(val.items.length - idx, 1);
          });
        }
      });
      return Object.entries(scores).sort((a, b) => b[1] - a[1]);
    };

    const beforeScores = calcScores(beforeLogs);
    const afterScores = calcScores(afterLogs);
    const maxScore = Math.max(
      beforeScores.length > 0 ? beforeScores[0][1] : 0,
      afterScores.length > 0 ? afterScores[0][1] : 0,
      1
    );

    const renderRankList = (scores, label, color) => {
      let html = `<h6 class="fw-bold text-${color} small mb-2">${label}</h6>`;
      scores.forEach(([item, score], idx) => {
        const pct = Math.round((score / maxScore) * 100);
        const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `${idx + 1}.`;
        html += `<div class="d-flex align-items-center mb-1">
          <span class="me-2" style="min-width: 24px;">${medal}</span>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between small"><span>${item}</span><span class="text-muted">${score}pt</span></div>
            <div class="progress" style="height: 4px;">
              <div class="progress-bar bg-${color}" style="width: ${pct}%"></div>
            </div>
          </div>
        </div>`;
      });
      return html;
    };

    return `<div class="row">
      <div class="col-6">${renderRankList(beforeScores, 'å°å…¥', 'primary')}</div>
      <div class="col-6">${renderRankList(afterScores, 'æŒ¯ã‚Šè¿”ã‚Š', 'danger')}</div>
    </div>`;
  }

  function renderCurveTeacherChart(beforeLogs, afterLogs, opts) {
    const ctx = document.getElementById('teacher-curve-chart');
    if (!ctx) return;

    const scenes = opts.scenes || ['ã¯ã˜ã‚', 'å±•é–‹', 'å±±å ´', 'çµæœ«'];
    const parseData = (logs) => {
      const sums = new Array(scenes.length).fill(0);
      let count = 0;
      logs.forEach(l => {
        let val = l.value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        if (val && val.data) {
          val.data.forEach((d, i) => { if (i < sums.length) sums[i] += d.value; });
          count++;
        }
      });
      return count > 0 ? sums.map(s => Math.round(s / count)) : sums;
    };

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: scenes,
        datasets: [
          { label: 'å°å…¥ï¼ˆå¹³å‡ï¼‰', data: parseData(beforeLogs), borderColor: 'rgba(26, 115, 232, 0.8)', borderWidth: 3, tension: 0.3, fill: false, pointRadius: 4 },
          { label: 'æŒ¯ã‚Šè¿”ã‚Šï¼ˆå¹³å‡ï¼‰', data: parseData(afterLogs), borderColor: 'rgba(234, 67, 53, 0.8)', borderWidth: 3, tension: 0.3, fill: false, pointRadius: 4 }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: { y: { min: 0, max: 100 } },
        plugins: { legend: { position: 'top' } },
        animation: false
      }
    });
  }

  function renderCurveTeacherTextView(beforeLogs, afterLogs) {
    const allLogs = [...beforeLogs.map(l => ({ ...l, phaseLabel: 'å°å…¥' })), ...afterLogs.map(l => ({ ...l, phaseLabel: 'æŒ¯è¿”ã‚Š' }))];
    const withText = allLogs.filter(l => l.text && l.text.trim());
    if (withText.length === 0) return '';

    let html = '<div class="mt-3 border-top pt-2">';
    withText.slice(0, 10).forEach(l => {
      const color = l.phaseLabel === 'å°å…¥' ? 'primary' : 'danger';
      html += `<div class="small mb-1"><span class="badge bg-${color} me-1">${l.phaseLabel}</span>${l.text}</div>`;
    });
    html += '</div>';
    return html;
  }

  function renderMandalaTeacherView(beforeLogs, afterLogs) {
    const collectWords = (logs) => {
      const counts = {};
      logs.forEach(l => {
        let val = l.value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        if (val && val.items) {
          val.items.filter(v => v && v.trim()).forEach(item => {
            counts[item.trim()] = (counts[item.trim()] || 0) + 1;
          });
        }
      });
      return Object.entries(counts).sort((a, b) => b[1] - a[1]);
    };

    const beforeWords = collectWords(beforeLogs);
    const afterWords = collectWords(afterLogs);

    const renderCloud = (words, label, color) => {
      let html = `<h6 class="fw-bold text-${color} small mb-2">${label}</h6>`;
      html += '<div class="d-flex flex-wrap gap-1 mb-3">';
      words.slice(0, 15).forEach(([word, count]) => {
        const size = count >= 3 ? 'fs-6 px-2' : 'small px-1';
        html += `<span class="badge bg-${color} bg-opacity-75 ${size}">${word}<sup>${count}</sup></span>`;
      });
      html += '</div>';
      return html;
    };

    return `<div class="row">
      <div class="col-6">${renderCloud(beforeWords, 'å°å…¥', 'primary')}</div>
      <div class="col-6">${renderCloud(afterWords, 'æŒ¯ã‚Šè¿”ã‚Š', 'danger')}</div>
    </div>`;
  }

  function renderActionTeacherView(beforeLogs, afterLogs) {
    const renderCards = (logs, label, color) => {
      let html = `<h6 class="fw-bold text-${color} small mb-2">${label}ï¼ˆ${logs.length}ä»¶ï¼‰</h6>`;
      logs.forEach(l => {
        let val = l.value;
        try { if (typeof val === 'string') val = JSON.parse(val); } catch (e) { }
        if (val && typeof val === 'object') {
          html += `<div class="card mb-1 border-start border-2 border-${color}">
            <div class="card-body py-1 px-2 small">
              ${val.what ? `<span class="fw-bold">${val.what}</span>` : ''}
              ${val.when ? `<span class="text-muted ms-1">(${val.when})</span>` : ''}
            </div>
          </div>`;
        }
      });
      return html;
    };

    return `<div class="row">
      <div class="col-6">${renderCards(beforeLogs, 'å°å…¥', 'primary')}</div>
      <div class="col-6">${renderCards(afterLogs, 'æŒ¯ã‚Šè¿”ã‚Š', 'danger')}</div>
    </div>`;
  }

  function loadScatterData() {
    if (!currentSession) return;

    const type = currentSession.inputType;
    const useScatter = (type === 'SLIDER' || type === 'QUADRANT');

    // ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®åˆ‡ã‚Šæ›¿ãˆ
    const scatterContainer = document.getElementById('chart-scatter-container');
    const patternContainer = document.getElementById('chart-pattern-container');
    if (scatterContainer) scatterContainer.classList.toggle('d-none', !useScatter);
    if (patternContainer) patternContainer.classList.toggle('d-none', useScatter);

    runGoogleScript('getSessionLogs', currentSession.id)
      .then(logs => {
        if (!useScatter) {
          // ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥å¯è¦–åŒ–
          renderTeacherPatternView(logs);
          return;
        }

        if (!scatterChart) return;

        // æ•£å¸ƒå›³: SLIDER / QUADRANT
        const isQuad = type === 'QUADRANT';
        if (isQuad) {
          scatterChart.options.scales.x.min = -100;
          scatterChart.options.scales.x.max = 100;
          scatterChart.options.scales.y.display = true;
          scatterChart.options.scales.y.min = -100;
          scatterChart.options.scales.y.max = 100;
          scatterChart.options.scales.x.title.text = '';
        } else {
          scatterChart.options.scales.x.min = 0;
          scatterChart.options.scales.x.max = 100;
          scatterChart.options.scales.y.display = false;
          scatterChart.options.scales.y.min = 0;
          scatterChart.options.scales.y.max = 10;

          // ãƒ©ãƒ™ãƒ«è¨­å®š
          let opts = {};
          try { opts = typeof currentSession.options === 'string' ? JSON.parse(currentSession.options) : (currentSession.options || {}); } catch (e) { }
          scatterChart.options.scales.x.title.text = `${opts.minLabel || 'A'} â† â†’ ${opts.maxLabel || 'B'}`;
        }

        const beforeData = [];
        const afterData = [];

        logs.forEach(l => {
          let x, y;

          if (isQuad) {
            try {
              const coord = JSON.parse(l.value);
              x = Number(coord.x);
              y = Number(coord.y);
            } catch (e) { x = 0; y = 0; }
          } else {
            x = Number(l.value) || 0;
            y = (simpleHash(l.logId || l.studentId || '') % 90) / 10 + 0.5;
          }

          const point = { x: x, y: y, text: l.text };

          if (l.phase === 'AFTER') {
            afterData.push(point);
          } else {
            beforeData.push(point);
          }
        });

        scatterChart.data.datasets[0].data = beforeData;
        scatterChart.data.datasets[1].data = afterData;
        scatterChart.update();
      })
      .catch(console.error);
  }

  // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆæ•™å¸«: æ•£å¸ƒå›³æ›´æ–° / ç”Ÿå¾’: ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´æ¤œçŸ¥ï¼‰
  setInterval(() => {
    if (localStorage.getItem('isTeacher') === 'true' && currentSession) {
      loadScatterData();
    } else {
      checkPhaseUpdate();
    }
  }, 5000);

  /**
   * AI Socrates (Gemini Integration)
   */
  function requestAiFeedback(sessionTitle, text, inputType, value) {
    runGoogleScript('generateSocraticQuestion', sessionTitle, text, inputType, value)
      .then(result => {
        if (result && result.success && result.question) {
          const card = document.getElementById('ai-feedback-card');
          const textEl = document.getElementById('ai-feedback-text');
          if (card && textEl) {
            textEl.innerText = result.question;
            card.classList.remove('d-none');
          }
        }
      })
      .catch(() => { }); // AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯å¤±æ•—ã—ã¦ã‚‚ç„¡è¦–
  }

  /**
   * Gemini API Key Management (Teacher)
   */
  function saveApiKey() {
    const key = document.getElementById('gemini-api-key-input').value.trim();
    runGoogleScript('saveGeminiApiKey', key)
      .then(() => {
        Swal.fire({ icon: 'success', title: 'ä¿å­˜ã—ã¾ã—ãŸ', timer: 1000, showConfirmButton: false });
        checkGeminiStatus();
      })
      .catch(showError);
  }

  function checkGeminiStatus() {
    runGoogleScript('hasGeminiApiKey')
      .then(result => {
        const el = document.getElementById('gemini-status');
        if (el) {
          el.innerHTML = result && result.hasKey
            ? '<span class="text-success"><i class="bi bi-check-circle"></i> APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿ï¼ˆAIå•ã„ã‹ã‘æ©Ÿèƒ½ONï¼‰</span>'
            : '<span class="text-muted"><i class="bi bi-x-circle"></i> æœªè¨­å®šï¼ˆè¨­å®šã™ã‚‹ã¨AIå•ã„ã‹ã‘æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ï¼‰</span>';
        }
      })
      .catch(() => { });
  }

  /**
   * Student Summaries (Teacher Report)
   */
  /**
   * ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã«å¤‰å®¹ã‚µãƒãƒªãƒ¼ã®å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   */
  function formatSummaryValue(type, value, text, color) {
    let val = value;
    try { if (typeof val === 'string' && (val.startsWith('{') || val.startsWith('['))) val = JSON.parse(val); } catch (e) { }

    let badge = '';
    if (type === 'SLIDER') {
      badge = `<span class="badge bg-${color} me-1">${value}</span>`;
    } else if (type === 'TAGS') {
      badge = `<span class="badge bg-${color} me-1">${value}</span>`;
    } else if (type === 'QUADRANT') {
      const coord = (typeof val === 'object') ? val : {};
      badge = `<span class="badge bg-${color} me-1">x:${coord.x || 0} y:${coord.y || 0}</span>`;
    } else if (type === 'RANKING') {
      const top = val?.items?.[0] || '-';
      badge = `<span class="badge bg-${color} me-1">1ä½: ${top}</span>`;
    } else if (type === 'CURVE') {
      badge = `<span class="badge bg-${color} me-1">å¿ƒæƒ…æ›²ç·š</span>`;
    } else if (type === 'MANDALA') {
      const count = val?.items ? val.items.filter(v => v).length : 0;
      badge = `<span class="badge bg-${color} me-1">${count}å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</span>`;
    } else if (type === 'ACTION') {
      const what = val?.what || '';
      badge = `<span class="badge bg-${color} me-1">å®£è¨€</span><span class="fw-bold">${what}</span>`;
    } else {
      badge = `<span class="badge bg-${color} me-1">${value}</span>`;
    }
    return `${badge} ${text || ''}`;
  }

  function loadStudentSummaries() {
    if (!currentSession) {
      Swal.fire('æˆæ¥­ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', '', 'warning');
      return;
    }
    const container = document.getElementById('summary-container');
    container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> èª­ã¿è¾¼ã¿ä¸­...</div>';

    runGoogleScript('getStudentSummaries', currentSession.id)
      .then(summaries => {
        if (!summaries || summaries.length === 0) {
          container.innerHTML = '<p class="text-muted small">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }
        const type = currentSession.inputType;
        container.innerHTML = summaries.map(s => {
          const before = s.before ? formatSummaryValue(type, s.before.value, s.before.text, 'primary') : '<span class="text-muted">æœªå›ç­”</span>';
          const after = s.after ? formatSummaryValue(type, s.after.value, s.after.text, 'danger') : '<span class="text-muted">æœªå›ç­”</span>';
          const changed = s.before && s.after && String(s.before.value) !== String(s.after.value);
          return `<div class="border rounded p-2 mb-2 ${changed ? 'border-warning' : ''}">
          <div class="fw-bold">${s.name} <small class="text-muted">(${s.ruby})</small> ${changed ? '<span class="badge bg-warning text-dark">å¤‰åŒ–ã‚ã‚Š</span>' : ''}</div>
          <div class="small mt-1"><span class="text-primary">å°å…¥:</span> ${before}</div>
          <div class="small"><span class="text-danger">æŒ¯ã‚Šè¿”ã‚Š:</span> ${after}</div>
        </div>`;
        }).join('');
      })
      .catch(showError);
  }

  // =================================================================
  // TEACHER: å­¦ç¿’å±¥æ­´ãƒ»æ‰€è¦‹ (HISTORY & OBSERVATION)
  // =================================================================

  const TYPE_LABELS = { SLIDER: 'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼', TAGS: 'æ„Ÿæƒ…ã‚¿ã‚°', QUADRANT: 'åº§æ¨™è»¸', RANKING: 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°', CURVE: 'å¿ƒæƒ…æ›²ç·š', MANDALA: 'ãƒãƒ³ãƒ€ãƒ©', ACTION: 'å®£è¨€ã‚«ãƒ¼ãƒ‰' };

  function loadHistoryDropdowns() {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ãƒ­ãƒ¼ãƒ‰
    runGoogleScript('getAllSessions').then(sessions => {
      const sel = document.getElementById('history-session-select');
      if (!sel) return;
      sel.innerHTML = '<option value="">-- æˆæ¥­ã‚’é¸ã‚“ã§ãã ã•ã„ --</option>';
      (sessions || []).forEach(s => {
        const d = new Date(s.date).toLocaleDateString('ja-JP');
        const type = TYPE_LABELS[s.inputType] || s.inputType;
        const status = s.status === 'ACTIVE' ? ' [å®Ÿæ–½ä¸­]' : '';
        sel.innerHTML += `<option value="${s.id}">${d} ${s.title} (${type})${status}</option>`;
      });
    });

    // å…ç«¥ä¸€è¦§ãƒ­ãƒ¼ãƒ‰ï¼ˆå…ç«¥åˆ¥å±¥æ­´ + æ‰€è¦‹ä½œæˆç”¨ï¼‰
    runGoogleScript('getStudents').then(res => {
      const users = res?.users || [];
      ['history-student-select', 'observation-student-select'].forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = '<option value="">-- å…ç«¥ã‚’é¸ã‚“ã§ãã ã•ã„ --</option>';
        users.forEach(u => {
          sel.innerHTML += `<option value="${u.id}">${u.name}ï¼ˆ${u.ruby}ï¼‰</option>`;
        });
      });
    });
  }

  // --- å˜å…ƒåˆ¥å±¥æ­´ ---
  function loadSessionHistory(sessionId) {
    const container = document.getElementById('history-session-detail');
    if (!sessionId) {
      container.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-arrow-up-circle d-block fs-1 mb-2 opacity-50"></i><p>æˆæ¥­ã‚’é¸ã‚“ã§ãã ã•ã„</p></div>';
      return;
    }

    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

    runGoogleScript('getStudentSummaries', sessionId).then(summaries => {
      if (!summaries || summaries.length === 0) {
        container.innerHTML = '<div class="alert alert-info">ã“ã®æˆæ¥­ã«ã¯ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
      const sel = document.getElementById('history-session-select');
      const selectedText = sel.options[sel.selectedIndex]?.text || '';

      let html = `<div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="fw-bold text-primary mb-0"><i class="bi bi-journal-text me-1"></i>${selectedText}</h6>
          <span class="badge bg-primary bg-opacity-10 text-primary">${summaries.length}å</span>
        </div>
        <hr class="my-2">
      </div>`;

      html += `<div class="table-responsive"><table class="table table-sm table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:120px;">åå‰</th>
            <th>å°å…¥æ™‚</th>
            <th>æŒ¯ã‚Šè¿”ã‚Š</th>
            <th style="width:60px;">å¤‰å®¹</th>
          </tr>
        </thead><tbody>`;

      summaries.forEach(s => {
        const bText = s.before?.text || '';
        const aText = s.after?.text || '';
        const bVal = s.before?.value ?? '-';
        const aVal = s.after?.value ?? '-';

        let change = '';
        if (s.before && s.after) {
          change = '<span class="badge bg-success bg-opacity-10 text-success"><i class="bi bi-check-circle"></i></span>';
        } else if (s.before && !s.after) {
          change = '<span class="badge bg-warning bg-opacity-10 text-warning">æœª</span>';
        }

        html += `<tr>
          <td class="fw-bold">${s.name}<br><small class="text-muted">${s.ruby}</small></td>
          <td><small class="badge bg-info bg-opacity-10 text-info me-1">${String(bVal).substring(0, 15)}</small><br><small class="text-muted">${bText ? bText.substring(0, 40) + (bText.length > 40 ? '...' : '') : ''}</small></td>
          <td><small class="badge bg-success bg-opacity-10 text-success me-1">${String(aVal).substring(0, 15)}</small><br><small class="text-muted">${aText ? aText.substring(0, 40) + (aText.length > 40 ? '...' : '') : ''}</small></td>
          <td class="text-center">${change}</td>
        </tr>`;
      });

      html += `</tbody></table></div>`;
      container.innerHTML = html;
    }).catch(() => {
      container.innerHTML = '<div class="alert alert-danger">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    });
  }

  // --- å…ç«¥åˆ¥å±¥æ­´ ---
  function loadStudentHistoryView(studentId) {
    const container = document.getElementById('history-student-detail');
    if (!studentId) {
      container.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-arrow-up-circle d-block fs-1 mb-2 opacity-50"></i><p>å…ç«¥ã‚’é¸ã‚“ã§ãã ã•ã„</p></div>';
      return;
    }

    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

    runGoogleScript('getStudentPortfolio', studentId).then(portfolio => {
      if (!portfolio || portfolio.length === 0) {
        container.innerHTML = '<div class="alert alert-info">ã“ã®å…ç«¥ã«ã¯ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      const sel = document.getElementById('history-student-select');
      const studentName = sel.options[sel.selectedIndex]?.text || '';

      let html = `<div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="fw-bold text-primary mb-0"><i class="bi bi-person me-1"></i>${studentName}</h6>
          <span class="badge bg-primary bg-opacity-10 text-primary">${portfolio.length}å›</span>
        </div>
        <hr class="my-2">
      </div>`;

      portfolio.forEach((p, idx) => {
        const d = new Date(p.date).toLocaleDateString('ja-JP');
        const type = TYPE_LABELS[p.inputType] || p.inputType;
        const hasChange = p.before && p.after;
        const borderColor = hasChange ? 'border-success' : 'border-secondary';

        html += `<div class="card mb-2 border-start border-3 ${borderColor}">
          <div class="card-body py-2 px-3">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <span class="fw-bold">${p.title}</span>
                <span class="badge bg-light text-muted ms-2">${type}</span>
              </div>
              <small class="text-muted">${d}</small>
            </div>`;

        if (p.before) {
          const bVal = String(p.before.value || '').substring(0, 20);
          html += `<div class="mt-1"><small class="text-muted">å°å…¥:</small> <small class="badge bg-info bg-opacity-10 text-info">${bVal}</small>`;
          if (p.before.text) html += ` <small class="text-muted">${p.before.text.substring(0, 50)}${p.before.text.length > 50 ? '...' : ''}</small>`;
          html += `</div>`;
        }

        if (p.after) {
          const aVal = String(p.after.value || '').substring(0, 20);
          html += `<div class="mt-1"><small class="text-muted">æŒ¯ã‚Šè¿”ã‚Š:</small> <small class="badge bg-success bg-opacity-10 text-success">${aVal}</small>`;
          if (p.after.text) html += ` <small class="text-muted">${p.after.text.substring(0, 50)}${p.after.text.length > 50 ? '...' : ''}</small>`;
          html += `</div>`;
        }

        html += `</div></div>`;
      });

      container.innerHTML = html;
    }).catch(() => {
      container.innerHTML = '<div class="alert alert-danger">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    });
  }

  // --- æ‰€è¦‹ä½œæˆ ---
  function previewStudentForObservation(studentId) {
    const preview = document.getElementById('observation-preview');
    const btn = document.getElementById('btn-generate-observation');
    const result = document.getElementById('observation-result');

    if (!studentId) {
      preview.innerHTML = '';
      btn.classList.add('d-none');
      result.classList.add('d-none');
      return;
    }

    preview.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';

    runGoogleScript('getStudentPortfolio', studentId).then(portfolio => {
      if (!portfolio || portfolio.length === 0) {
        preview.innerHTML = '<div class="alert alert-info">ã“ã®å…ç«¥ã«ã¯ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        btn.classList.add('d-none');
        return;
      }

      let html = `<div class="card border">
        <div class="card-header bg-light py-2">
          <small class="fw-bold"><i class="bi bi-journal-text me-1"></i>å­¦ç¿’è¨˜éŒ²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ${portfolio.length}å›åˆ†ï¼‰</small>
        </div>
        <div class="card-body p-0" style="max-height: 250px; overflow-y: auto;">
          <table class="table table-sm mb-0">
            <thead class="table-light sticky-top"><tr><th>æˆæ¥­</th><th>å½¢å¼</th><th>å°å…¥</th><th>æŒ¯ã‚Šè¿”ã‚Š</th></tr></thead>
            <tbody>`;

      portfolio.forEach(p => {
        const d = new Date(p.date).toLocaleDateString('ja-JP');
        const type = TYPE_LABELS[p.inputType] || p.inputType;
        html += `<tr>
          <td><small>${p.title}<br><span class="text-muted">${d}</span></small></td>
          <td><small>${type}</small></td>
          <td><small>${p.before?.text ? p.before.text.substring(0, 30) + '...' : '-'}</small></td>
          <td><small>${p.after?.text ? p.after.text.substring(0, 30) + '...' : '-'}</small></td>
        </tr>`;
      });

      html += `</tbody></table></div></div>`;
      preview.innerHTML = html;
      btn.classList.remove('d-none');
      result.classList.add('d-none');
    }).catch(() => {
      preview.innerHTML = '<div class="alert alert-danger">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    });
  }

  function generateObservationForStudent() {
    const sel = document.getElementById('observation-student-select');
    const studentId = sel.value;
    if (!studentId) return;

    const btn = document.getElementById('btn-generate-observation');
    const result = document.getElementById('observation-result');
    const textarea = document.getElementById('observation-text');

    btn.disabled = true;
    btn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>AIãŒæ‰€è¦‹ã‚’ä½œæˆä¸­...';

    runGoogleScript('generateObservation', studentId)
      .then(res => {
        if (res.success) {
          textarea.value = res.observation;
          result.classList.remove('d-none');
          Swal.fire({ icon: 'success', title: 'æ‰€è¦‹ã‚’ä½œæˆã—ã¾ã—ãŸ', timer: 1500, showConfirmButton: false });
        } else {
          Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: res.error || 'æ‰€è¦‹ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' });
        }
      })
      .catch(err => {
        Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' });
      })
      .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-magic me-1"></i> AIã§æ‰€è¦‹ã‚’ä½œæˆ';
      });
  }

  function copyObservation() {
    const textarea = document.getElementById('observation-text');
    textarea.select();
    document.execCommand('copy');
    Swal.fire({ icon: 'success', title: 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', timer: 1000, showConfirmButton: false });
  }

  /**
   * My Log (Student History)
   */
  function showMyLog() {
    if (!currentUser) return;
    showView('view-mylog');

    // Reset chart
    if (window.myPortfolioChartInstance) {
      try {
        window.myPortfolioChartInstance.destroy();
      } catch (e) { console.warn(e); }
      window.myPortfolioChartInstance = null;
    }
    document.getElementById('mylog-list').innerHTML = '<div class="text-center text-muted"><div class="spinner-border spinner-border-sm"></div> èª­ã¿è¾¼ã¿ä¸­...</div>';

    runGoogleScript('getStudentPortfolio', currentUser.id)
      .then(portfolio => {
        if (!portfolio || portfolio.length === 0) {
          document.getElementById('mylog-list').innerHTML = '<p class="text-muted text-center pt-3">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }

        // 1. Render Chart (Slider only)
        renderPortfolioChart(portfolio);

        // 2. Render List
        const html = portfolio.map(item => {
          const dateStr = item.date ? new Date(item.date).toLocaleDateString('ja-JP') : '';
          const typeLabels = {
            SLIDER: 'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼', TAGS: 'æ„Ÿæƒ…ã‚¿ã‚°', QUADRANT: 'åº§æ¨™è»¸',
            RANKING: 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°', CURVE: 'å¿ƒæƒ…æ›²ç·š', MANDALA: 'ãƒãƒ³ãƒ€ãƒ©', ACTION: 'å®£è¨€ã‚«ãƒ¼ãƒ‰'
          };
          let body = '';

          // Before
          if (item.before) {
            body += `<div class="small mb-1"><span class="fw-bold text-primary me-2">å°å…¥</span> ${formatSummaryValue(item.inputType, item.before.value, item.before.text, 'primary')}</div>`;
          }

          // After
          if (item.after) {
            body += `<div class="small"><span class="fw-bold text-danger me-2">æŒ¯ã‚Šè¿”ã‚Š</span> ${formatSummaryValue(item.inputType, item.after.value, item.after.text, 'danger')}</div>`;
          }

          return `<div class="card mb-2">
          <div class="card-body py-2">
            <div class="d-flex justify-content-between">
              <span class="fw-bold text-truncate">${item.title} <span class="badge bg-light text-muted border small">${typeLabels[item.inputType] || item.inputType}</span></span>
              <small class="text-muted">${dateStr}</small>
            </div>
            <hr class="my-1">
            ${body}
          </div>
        </div>`;
        }).join('');

        document.getElementById('mylog-list').innerHTML = html;
      })
      .catch(showError);
  }

  function renderPortfolioChart(portfolio) {
    // Filter for SLIDER sessions
    const data = portfolio.filter(p => p.inputType === 'SLIDER').reverse(); // Chronological order
    if (data.length === 0) return;

    const ctx = document.getElementById('portfolioChart');
    if (!ctx) return; // Canvas element needs to be added to index.html

    window.myPortfolioChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => new Date(d.date).toLocaleDateString('ja-JP')),
        datasets: [
          {
            label: 'å°å…¥',
            data: data.map(d => d.before ? d.before.value : null),
            borderColor: 'rgba(26, 115, 232, 0.6)',
            backgroundColor: 'rgba(26, 115, 232, 0.6)',
            tension: 0.1,
            spanGaps: true
          },
          {
            label: 'æŒ¯ã‚Šè¿”ã‚Š',
            data: data.map(d => d.after ? d.after.value : null),
            borderColor: 'rgba(234, 67, 53, 0.6)',
            backgroundColor: 'rgba(234, 67, 53, 0.6)',
            tension: 0.1,
            spanGaps: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { min: 0, max: 100 }
        },
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'å¿ƒã®ä½ç½®ã®å¤‰åŒ–' }
        }
      }
    });
  }

  function backFromMyLog() {
    if (currentSession) {
      if (currentPhase === 'AFTER') {
        showReflectionView();
      } else {
        showView('view-entry');
      }
    } else {
      showView('view-waiting');
    }
  }

  /**
   * Unit Management Functions
   */
  function loadUnits() {
    const container = document.getElementById('unit-list-container');
    if (!container) return;

    container.innerHTML = '<div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div> èª­ã¿è¾¼ã¿ä¸­...</div>';

    runGoogleScript('getUnits')
      .then(units => {
        if (!units || units.length === 0) {
          container.innerHTML = '<div class="text-center text-muted py-3">ç™»éŒ²ã•ã‚ŒãŸå˜å…ƒã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        container.innerHTML = units.map(u => {
          const typeLabels = {
            SLIDER: '<span class="badge bg-info text-dark">ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼</span>',
            TAGS: '<span class="badge bg-warning text-dark">æ„Ÿæƒ…ã‚¿ã‚°</span>',
            QUADRANT: '<span class="badge bg-secondary">åº§æ¨™è»¸</span>',
            RANKING: '<span class="badge bg-primary">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>',
            CURVE: '<span class="badge bg-success">å¿ƒæƒ…æ›²ç·š</span>',
            MANDALA: '<span class="badge bg-warning text-dark">ãƒãƒ³ãƒ€ãƒ©</span>',
            ACTION: '<span class="badge bg-success">å®£è¨€ã‚«ãƒ¼ãƒ‰</span>'
          };
          const typeLabel = typeLabels[u.inputType] || `<span class="badge bg-light text-dark">${u.inputType}</span>`;
          const dateStr = new Date(u.createdAt).toLocaleDateString();

          return `<div class="list-group-item list-group-item-action" onclick="editUnit('${u.unitId}')" style="cursor: pointer;">
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1 fw-bold text-primary">${u.title}</h6>
            <small class="text-muted">${dateStr}</small>
          </div>
          <p class="mb-1 small">${typeLabel} ${u.memo ? ' - ' + u.memo : ''}</p>
          <div class="mt-2 text-end">
            <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteUnit(event, '${u.unitId}')">å‰Šé™¤</button>
            <button class="btn btn-sm btn-success" onclick="startUnit(event, '${u.unitId}')">ã“ã®å˜å…ƒã§é–‹å§‹</button>
          </div>
        </div>`;
        }).join('');
      })
      .catch(showError);
  }

  function importUnitFromPdf() {
    const fileInput = document.getElementById('pdf-file-input');
    if (fileInput.files.length === 0) {
      Swal.fire('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', '', 'warning');
      return;
    }

    const file = fileInput.files[0];
    if (file.type !== 'application/pdf') {
      Swal.fire('PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™', '', 'error');
      return;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ (ä¾‹: 5MBä»¥ä¸‹)
    if (file.size > 5 * 1024 * 1024) {
      Swal.fire('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ (5MBä»¥ä¸‹)', '', 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      const base64 = e.target.result.split(',')[1]; // data:application/pdf;base64,.....

      Swal.fire({
        title: 'AIè§£æä¸­...',
        text: 'PDFã‹ã‚‰æˆæ¥­è¨­å®šã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      runGoogleScript('parseLessonPdf', base64)
        .then(result => {
          if (result && result.success && result.data) {
            Swal.close();
            // ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
            const d = result.data;

            // Case 1: Multiple Units (Bulk)
            if (d.units && Array.isArray(d.units) && d.units.length > 0) {
              showBulkImportModal(d.units);
              fileInput.value = '';
              return;
            }

            // Case 2: Single Unit (Fallback)
            const unit = (d.units && d.units.length === 1) ? d.units[0] : d;
            fillUnitForm(unit);

            Swal.fire({
              icon: 'success',
              title: 'èª­ã¿å–ã‚ŠæˆåŠŸ',
              text: 'å†…å®¹ã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ã¦ã€Œä¿å­˜ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'
            });

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒªã‚»ãƒƒãƒˆ
            fileInput.value = '';
          } else {
            throw new Error(result.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .catch(showError);
    };

    reader.onerror = function () {
      Swal.fire('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', '', 'error');
    };

    reader.readAsDataURL(file);
  }

  function toggleUnitEditOptions() {
    const type = document.getElementById('edit-unit-type').value;
    const types = ['slider', 'tags', 'quadrant', 'ranking', 'curve', 'mandala'];
    types.forEach(t => {
      const el = document.getElementById('edit-unit-opts-' + t);
      if (el) el.classList.toggle('d-none', type !== t.toUpperCase());
    });
  }

  function clearUnitForm() {
    document.getElementById('edit-unit-id').value = '';
    document.getElementById('edit-unit-title').value = '';
    document.getElementById('edit-unit-min').value = '';
    document.getElementById('edit-unit-max').value = '';
    document.getElementById('edit-unit-tags').value = '';
    document.getElementById('edit-unit-memo').value = '';
  }

  function editUnit(unitId) {
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆï¼ˆãƒªã‚¹ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãã®ãŒæ—©ã„ãŒã€ã“ã“ã§ã¯å†åº¦å–å¾—ã›ãšDOMã‹ã‚‰...ã„ã‚„ã€ãƒªã‚¹ãƒˆã«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ãŠã†ï¼‰
    runGoogleScript('getUnits').then(units => {
      const u = units.find(x => x.unitId === unitId);
      if (!u) return;

      document.getElementById('edit-unit-id').value = u.unitId;
      document.getElementById('edit-unit-title').value = u.title;
      document.getElementById('edit-unit-type').value = u.inputType;
      document.getElementById('edit-unit-memo').value = u.memo;

      toggleUnitEditOptions();

      const opts = u.options || {};
      if (u.inputType === 'SLIDER') {
        document.getElementById('edit-unit-min').value = opts.minLabel || '';
        document.getElementById('edit-unit-max').value = opts.maxLabel || '';
      } else if (u.inputType === 'TAGS') {
        document.getElementById('edit-unit-tags').value = (opts.tags || []).join(',');
      } else if (u.inputType === 'QUADRANT') {
        document.getElementById('edit-unit-quad-xmin').value = opts.xAxisLabel?.[0] || '';
        document.getElementById('edit-unit-quad-xmax').value = opts.xAxisLabel?.[1] || '';
        document.getElementById('edit-unit-quad-ymin').value = opts.yAxisLabel?.[0] || '';
        document.getElementById('edit-unit-quad-ymax').value = opts.yAxisLabel?.[1] || '';
      } else if (u.inputType === 'RANKING') {
        document.getElementById('edit-unit-ranking-items').value = (opts.items || []).join(',');
      } else if (u.inputType === 'CURVE') {
        document.getElementById('edit-unit-curve-scenes').value = (opts.scenes || []).join(',');
      } else if (u.inputType === 'MANDALA') {
        document.getElementById('edit-unit-mandala-theme').value = opts.centerTheme || '';
      }
    });
  }

  function saveUnitForm() {
    const id = document.getElementById('edit-unit-id').value;
    const title = document.getElementById('edit-unit-title').value;
    if (!title) { Swal.fire('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', '', 'warning'); return; }

    const type = document.getElementById('edit-unit-type').value;
    let options = {};

    if (type === 'SLIDER') {
      options = {
        minLabel: document.getElementById('edit-unit-min').value || 'A',
        maxLabel: document.getElementById('edit-unit-max').value || 'B'
      };
    } else if (type === 'TAGS') {
      const tVal = document.getElementById('edit-unit-tags').value;
      options = { tags: tVal ? tVal.split(/[,ã€ï¼Œ]/).map(t => t.trim()) : ['å…±æ„Ÿ', 'ç–‘å•', 'ç´å¾—', 'é©šã'] };
    } else if (type === 'QUADRANT') {
      options = {
        xAxisLabel: [
          document.getElementById('edit-unit-quad-xmin').value || 'å·¦',
          document.getElementById('edit-unit-quad-xmax').value || 'å³'
        ],
        yAxisLabel: [
          document.getElementById('edit-unit-quad-ymin').value || 'ä¸‹',
          document.getElementById('edit-unit-quad-ymax').value || 'ä¸Š'
        ]
      };
    } else if (type === 'RANKING') {
      const rVal = document.getElementById('edit-unit-ranking-items').value;
      options = { items: rVal ? rVal.split(/[,ã€ï¼Œ]/).map(t => t.trim()) : ['é …ç›®A', 'é …ç›®B', 'é …ç›®C'] };
    } else if (type === 'CURVE') {
      const cVal = document.getElementById('edit-unit-curve-scenes').value;
      options = { scenes: cVal ? cVal.split(/[,ã€ï¼Œ]/).map(t => t.trim()) : ['ã¯ã˜ã‚', 'å±•é–‹', 'å±±å ´', 'çµæœ«'] };
    } else if (type === 'MANDALA') {
      options = { centerTheme: document.getElementById('edit-unit-mandala-theme').value || 'ãƒ†ãƒ¼ãƒ' };
    } else if (type === 'ACTION') {
      options = {};
    }

    const memo = document.getElementById('edit-unit-memo').value;

    const payload = {
      unitId: id,
      title: title,
      inputType: type,
      options: options,
      memo: memo
    };

    Swal.fire({ title: 'ä¿å­˜ä¸­...', didOpen: () => Swal.showLoading() });

    runGoogleScript('saveUnit', payload)
      .then(() => {
        Swal.fire({ icon: 'success', title: 'ä¿å­˜ã—ã¾ã—ãŸ', timer: 1000, showConfirmButton: false });
        clearUnitForm();
        loadUnits();
      })
      .catch(showError);
  }

  function deleteUnit(event, unitId) {
    event.stopPropagation();
    event.preventDefault();
    if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    runGoogleScript('deleteUnit', unitId)
      .then(() => loadUnits())
      .catch(showError);
  }

  function startUnit(event, unitId) {
    event.stopPropagation();
    event.preventDefault();
    Swal.fire({
      title: 'ã“ã®å˜å…ƒã§æˆæ¥­ã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ',
      text: 'ç¾åœ¨é€²è¡Œä¸­ã®æˆæ¥­ã¯çµ‚äº†ã•ã‚Œã¾ã™',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'é–‹å§‹ã™ã‚‹'
    }).then(res => {
      if (res.isConfirmed) {
        Swal.fire({ title: 'æº–å‚™ä¸­...', didOpen: () => Swal.showLoading() });
        runGoogleScript('startSessionFromUnit', unitId)
          .then(() => {
            Swal.fire({ icon: 'success', title: 'æˆæ¥­ã‚’é–‹å§‹ã—ã¾ã—ãŸ', text: 'ç”Ÿå¾’ç”»é¢ãŒæ›´æ–°ã•ã‚Œã¾ã™' });
            // ç”»é¢æ›´æ–°
            runGoogleScript('getInitialData').then(response => {
              if (response && response.success && response.activeSession) {
                currentSession = response.activeSession;
                loadScatterData();
              }
            });
          })
          .catch(showError);
      }
    });
  }

  /**
   * =================================================================
   * 6. GASé€£æºãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (GAS WRAPPER & UTILS)
   * =================================================================
   */
  function showError(err) {
    console.error(err);
    Swal.fire({
      icon: 'error',
      title: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
      text: err.toString()
    });
  }

  function runGoogleScript(funcName, ...args) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
      [funcName](...args);
    });
  }


  /**
   * SPA Navigation (No Reload)
   */
  function resetApp() {
    // çŠ¶æ…‹ã‚¯ãƒªã‚¢
    currentUser = null;
    currentSession = null;
    currentPhase = 'BEFORE';
    isAutoLogin = false;
    if (scatterChart) {
      scatterChart.destroy();
      scatterChart = null;
    }

    // UIåˆæœŸåŒ–
    document.getElementById('loading').classList.remove('d-none');
    const allViews = document.querySelectorAll('[id^="view-"]');
    allViews.forEach(el => el.classList.add('d-none'));

    // ãƒ‡ãƒ¼ã‚¿å†å–å¾—
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç­‰ã¯ãã®ã¾ã¾å†åˆ©ç”¨
    // dispatchEventã¨åŒç­‰ã®å‡¦ç†ã‚’DOMContentLoadedã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç›´ä¸‹ã‹ã‚‰æŠ½å‡ºã—ã¦é–¢æ•°åŒ–ã™ã¹ãã ãŒã€
    // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«DOMContentLoadedã®ä¸­èº«ç›¸å½“ã‚’å†å®Ÿè¡Œã™ã‚‹å½¢ã‚’ã¨ã‚‹ã‹ã€
    // ã‚ã‚‹ã„ã¯ reload ã®ä»£ã‚ã‚Šã« init å‡¦ç†ã‚’å‘¼ã¶ã€‚

    // æ—¢å­˜ã®DOMContentLoadedãƒ­ã‚¸ãƒƒã‚¯ã‚’é–¢æ•°åŒ–ã—ã¦ã„ãªã„ãŸã‚ã€
    // ç°¡æ˜“çš„ã«location.reload()ã®ä»£æ›¿ã¨ã—ã¦åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ã‚’èµ°ã‚‰ã›ã‚‹ã€‚
    // ãŸã ã—ã€EventListenerã¯äºŒé‡ç™»éŒ²ã—ãªã„ã‚ˆã†ã«æ³¨æ„ãŒå¿…è¦ã€‚

    // ã“ã“ã§ã¯ä¸»è¦ãªåˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œã™ã‚‹
    initAppFlow();
  }

  // æ—¢å­˜ã®DOMContentLoadedã‚’é–¢æ•°ã«åˆ‡ã‚Šå‡ºã—
  function initAppFlow() {
    // 1. å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
    const isTeacher = localStorage.getItem('isTeacher') === 'true';
    const loader = document.getElementById('loading');
    if (loader) loader.classList.remove('d-none');

    if (isTeacher) {
      showView('view-teacher');
    }

    // 3. ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹
    runGoogleScript('getInitialData')
      .then(response => {
        if (loader) loader.classList.add('d-none');

        if (!response || !response.success) {
          throw new Error(response ? response.error : 'ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—');
        }

        const data = response;

        // å…ˆç”Ÿãªã‚‰ãƒ­ã‚¸ãƒƒã‚¯çµ‚äº†
        if (isTeacher) {
          if (data.activeSession) {
            currentSession = data.activeSession;
            updatePhaseButtons(currentSession.phase || 'BEFORE');
          } else {
            currentSession = null;
            updatePhaseButtons('CLOSED');
          }
          renderRoster(data.users);
          initChart();
          loadScatterData();
          checkGeminiStatus();
          return;
        }

        // === ç”Ÿå¾’ç”¨ãƒ­ã‚¸ãƒƒã‚¯ ===

        // ãƒ¡ãƒ¼ãƒ«è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³åˆ¤å®š
        const autoStudent = data.autoLoginStudent;

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«åç°¿ã‚’ã‚»ãƒƒãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        const select = document.getElementById('student-select');
        if (data.users && Array.isArray(data.users) && data.users.length > 0) {
          select.innerHTML = '<option value="" selected disabled>ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸ã¶</option>';
          data.users.forEach(u => {
            const option = document.createElement('option');
            option.value = u.id;
            option.innerHTML = `${u.name} <small>(${u.ruby})</small>`;
            select.appendChild(option);
          });
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if (data.activeSession) {
          currentSession = data.activeSession;
          currentPhase = currentSession.phase || 'BEFORE';
          setupSessionUI(currentSession);

          const phaseLabels = { BEFORE: 'ä»Šã®è€ƒãˆã‚’æ•™ãˆã¦ã­', AFTER: 'æŒ¯ã‚Šè¿”ã‚Šã®æ™‚é–“ã§ã™' };
          const phaseLabel = document.getElementById('phase-label');
          if (phaseLabel && phaseLabels[currentPhase]) {
            phaseLabel.innerHTML = phaseLabels[currentPhase];
          }
        }

        // --- è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
        if (autoStudent) {
          isAutoLogin = true;
          localStorage.setItem('studentId', autoStudent.id);

          // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const autoMsg = document.getElementById('auto-login-msg');
          const manualForm = document.getElementById('manual-login-form');
          const autoName = document.getElementById('auto-login-name');
          if (autoMsg) autoMsg.classList.remove('d-none');
          if (manualForm) manualForm.classList.add('d-none');
          if (autoName) autoName.textContent = autoStudent.name;

          showView('view-login');

          // å°‘ã—ã ã‘è¡¨ç¤ºã—ã¦ã‹ã‚‰è‡ªå‹•é·ç§»
          setTimeout(() => {
            login(autoStudent.id);
          }, 800);
          return;
        }

        // --- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ ---
        isAutoLogin = false;
        const autoMsg = document.getElementById('auto-login-msg');
        const manualForm = document.getElementById('manual-login-form');
        if (autoMsg) autoMsg.classList.add('d-none');
        if (manualForm) manualForm.classList.remove('d-none');

        // localStorage ã‹ã‚‰ã®å¾©å…ƒ
        const storedUid = localStorage.getItem('studentId');
        if (storedUid) {
          currentUser = { id: storedUid };
        }

        if (currentSession) {
          if (storedUid) {
            if (currentPhase === 'AFTER') {
              showReflectionView();
            } else {
              showView('view-entry');
            }
          } else {
            showView('view-login');
          }
        } else {
          if (storedUid) {
            showView('view-waiting');
          } else {
            showView('view-login');
          }
        }
      })
      .catch(err => {
        if (loader) loader.classList.add('d-none');
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'é€šä¿¡ã‚¨ãƒ©ãƒ¼',
          text: 'å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã‹ï¼Ÿ',
          showCancelButton: true,
          confirmButtonText: 'å†èª­ã¿è¾¼ã¿',
        }).then((result) => {
          if (result.isConfirmed) {
            resetApp();
          }
        });
      });
  }



  // ==========================================
  // Bulk Import Functions
  // ==========================================

  function fillUnitForm(d) {
    document.getElementById('edit-unit-id').value = ''; // æ–°è¦æ‰±ã„
    document.getElementById('edit-unit-title').value = d.title || '';
    document.getElementById('edit-unit-type').value = d.inputType || 'SLIDER';
    document.getElementById('edit-unit-memo').value = d.memo || '';

    toggleUnitEditOptions();

    if (d.inputType === 'SLIDER' && d.options) {
      document.getElementById('edit-unit-min').value = d.options.minLabel || '';
      document.getElementById('edit-unit-max').value = d.options.maxLabel || '';
    } else if (d.inputType === 'TAGS' && d.options && d.options.tags) {
      document.getElementById('edit-unit-tags').value = Array.isArray(d.options.tags) ? d.options.tags.join(',') : d.options.tags;
    }
  }

  let bulkUnitsCache = [];

  function showBulkImportModal(units) {
    bulkUnitsCache = units;
    const list = document.getElementById('bulk-import-list');
    list.innerHTML = '';

    units.forEach((u, idx) => {
      const isChecked = true;
      const typeLabel = u.inputType === 'SLIDER' ? '<span class="badge bg-primary">ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼</span>' : '<span class="badge bg-success">æ„Ÿæƒ…ã‚¿ã‚°</span>';

      const html = `
      <label class="list-group-item d-flex gap-2">
        <input class="form-check-input flex-shrink-0" type="checkbox" value="${idx}" ${isChecked ? 'checked' : ''} style="transform: scale(1.3); margin-top: 0.3em;">
        <div class="flex-grow-1 ms-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <h6 class="mb-0 fw-bold">${u.title || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰'}</h6>
            ${typeLabel}
          </div>
          <small class="text-muted text-truncate d-block" style="max-width: 100%;">${u.memo || ''}</small>
        </div>
      </label>
    `;
      list.innerHTML += html;
    });

    const modal = new bootstrap.Modal(document.getElementById('bulkImportModal'));
    modal.show();
  }

  function saveBulkUnits() {
    const checkboxes = document.querySelectorAll('#bulk-import-list input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
      Swal.fire('ç™»éŒ²ã™ã‚‹å˜å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„', '', 'warning');
      return;
    }

    const selectedUnits = Array.from(checkboxes).map(cb => bulkUnitsCache[parseInt(cb.value)]);
    const modal = bootstrap.Modal.getInstance(document.getElementById('bulkImportModal'));
    modal.hide();

    Swal.fire({
      title: 'ä¸€æ‹¬ç™»éŒ²ä¸­...',
      text: `${selectedUnits.length}ä»¶ã®å˜å…ƒã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™`,
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    saveNextUnit(selectedUnits, 0);
  }

  function saveNextUnit(units, index) {
    if (index >= units.length) {
      Swal.fire({ icon: 'success', title: 'å®Œäº†', text: `${units.length}ä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ` });
      loadUnits();
      return;
    }

    const u = units[index];
    const payload = {
      unitId: '',
      title: u.title,
      inputType: u.inputType,
      options: u.options,
      memo: u.memo
    };

    runGoogleScript('saveUnit', payload)
      .then(() => {
        saveNextUnit(units, index + 1);
      })
      .catch(err => {
        console.error(err);
        Swal.fire('ã‚¨ãƒ©ãƒ¼', `${index + 1}ä»¶ç›®ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${u.title}`, 'error');
      });
  }
</script>